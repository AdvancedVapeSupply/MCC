<!DOCTYPE html>
<html>
<head>
    <title>AVS M22 MCC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" type="image/x-icon" href="https://www.advancedvapesupply.com/cdn/shop/files/AVS_Molecule_5_180x180.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/brands.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap">
    <script type="importmap">
    {
        "imports": {
            "esptool-js": "https://cdn.jsdelivr.net/npm/esptool-js@0.3.0/bundle.js",
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "three/examples/jsm/controls/OrbitControls": "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js",
            "three/examples/jsm/renderers/CSS3DRenderer": "https://unpkg.com/three@0.160.0/examples/jsm/renderers/CSS3DRenderer.js",
            "esp-web-tools": "https://unpkg.com/esp-web-tools@9.4.3/dist/web/install-button.js?module"
        }
    }
    </script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="js/serial-manager.js"></script>
    <script type="module" src="js/ble-monitor.js"></script>
    <script type="module" src="chip_info.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-green: #00ff00;
            --neon-green-glow: 0 0 10px rgba(0, 255, 0, 0.5);
            --neon-green-intense: 0 0 20px rgba(0, 255, 0, 0.8), 0 0 30px rgba(0, 255, 0, 0.6);
            --neon-blue: #0088ff;
            --neon-blue-glow: 0 0 10px rgba(0, 136, 255, 0.5);
            --neon-blue-intense: 0 0 20px rgba(0, 136, 255, 0.8), 0 0 30px rgba(0, 136, 255, 0.6);
            --neon-cyan: #00ffff;
            --neon-cyan-glow: 0 0 10px rgba(0, 255, 255, 0.5);
            --neon-cyan-intense: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 30px rgba(0, 255, 255, 0.6);
            --neon-red: #e31837;
            --neon-red-glow: 0 0 10px rgba(227, 24, 55, 0.5);
            --neon-red-intense: 0 0 20px rgba(227, 24, 55, 0.8), 0 0 30px rgba(227, 24, 55, 0.6);
            --neon-yellow: #ffd43b;
            --neon-yellow-glow: 0 0 10px rgba(255, 212, 59, 0.5);
            --neon-yellow-intense: 0 0 20px rgba(255, 212, 59, 0.8), 0 0 30px rgba(255, 212, 59, 0.6);
            --tile-background: #1a1a1a;
            --border-color: rgba(0, 255, 0, 0.3);
        }

        /* Hide conditional tiles by default */
        #esp32-tile, #python-tile {
            opacity: 0.5;
            filter: grayscale(70%);
        }

        #esp32-icon, #python-icon {
            opacity: 0.3;
        }

        body { 
            margin: 0; 
            overflow: hidden;
            background: #000000;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--neon-green);
        }

        /* iPhone Status Bar */
        #iphone-status-bar {
            width: 100%;
            height: 44px;
            background: rgba(0, 20, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: var(--neon-green);
            font-weight: 600;
            text-shadow: var(--neon-green-glow);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .battery-icon {
            width: 25px;
            height: 12px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 3px;
            position: relative;
            margin-left: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .battery-icon::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 3px;
            width: 2px;
            height: 4px;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 0 1px 1px 0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .battery-icon.active {
            border-color: var(--neon-green);
            box-shadow: var(--neon-green-glow);
            opacity: 1;
        }

        .battery-icon.active::after {
            background: var(--neon-green);
            box-shadow: var(--neon-green-glow);
        }

        .battery-level {
            position: absolute;
            left: 1px;
            top: 1px;
            bottom: 1px;
            width: 0%;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .battery-icon.active .battery-level {
            background: var(--neon-green);
            box-shadow: var(--neon-green-intense);
        }

        /* App Container */
        #app-container {
            width: 100%;
            max-width: 430px;
            height: 100vh;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Control Panel */
        #control-panel {
            width: 100%;
            padding: 10px;
            background: linear-gradient(145deg, rgba(0, 40, 0, 0.9) 0%, rgba(0, 20, 0, 0.9) 100%);
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
            box-shadow: 0 2px 10px rgba(0, 255, 0, 0.1);
        }

        .switch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .switch-container span {
            font-size: 12px;
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
        }

        .toggle-switch {
            width: 36px;
            height: 18px;
            background: rgba(0, 40, 0, 0.6);
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 1px 3px rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #1a1a1a;
            border-radius: 50%;
            top: 0px;
            left: 0px;
            transition: all 0.3s;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }

        .toggle-switch.active {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .toggle-switch.active::after {
            transform: translateX(18px);
            background: var(--neon-green);
            box-shadow: var(--neon-green-intense);
        }

        .indicator-light {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #300;
            box-shadow: inset 0 0 2px rgba(255, 0, 0, 0.5);
        }

        .indicator-light.active {
            background: var(--neon-green);
            box-shadow: var(--neon-green-intense);
        }

        /* Main Display */
        #main-display {
            flex: 1;
            padding: 10px 15px 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: calc(100vh - 44px);
            overflow: hidden;
            justify-content: space-between;
        }

        #porthole-container {
            flex: 1;
            width: 100%;
            position: relative;
            background: transparent;
            min-height: 0;
            margin-top: 20px;
        }

        #porthole-inner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            overflow: hidden;
        }

        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        /* Terminal Panel Container */
        .terminal-container {
            flex: 1;
            position: relative;
            min-height: 150px;
            max-height: 250px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Terminal Panel */
        #terminal-panel {
            flex: 1;
            font-family: 'Fira Code', monospace;
            font-size: 10px;
            line-height: 1.2;
            color: #00ff00;
            padding: 8px;
            overflow-y: auto;
            overflow-x: auto;
            white-space: nowrap;
            max-height: 100%;
        }

        .terminal-line {
            margin-bottom: 2px;
            white-space: nowrap;
        }

        .terminal-line.error {
            color: #ff3333;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .terminal-line.esp32 {
            color: var(--neon-red);
            text-shadow: var(--neon-red-glow);
        }

        .terminal-line.python {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }

        .terminal-line.wifi {
            color: var(--neon-cyan);
            text-shadow: var(--neon-cyan-glow);
        }

        .terminal-line.ble {
            color: var(--neon-blue);
            text-shadow: var(--neon-blue-glow);
        }

        .terminal-copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--neon-green);
            font-size: 12px;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .terminal-copy-btn:hover {
            background: rgba(0, 255, 0, 0.2);
            box-shadow: var(--neon-green-glow);
        }

        .terminal-copy-btn.copied {
            color: #44ff44;
            border-color: #44ff44;
        }

        #cursor {
            display: inline-block;
            width: 6px;
            height: 12px;
            background: var(--neon-green);
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 4px;
            box-shadow: var(--neon-green-glow);
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* Safari Bottom Bar */
        #safari-bar {
            width: 100%;
            height: 45px;
            background: rgba(0, 20, 0, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            border-top: 1px solid rgba(0, 255, 0, 0.2);
        }

        .url-bar {
            flex: 1;
            height: 32px;
            margin: 0 10px;
            background: rgba(0, 40, 0, 0.6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 14px;
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 0, 0.3);
            text-shadow: var(--neon-green-glow);
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
            font-size: 20px;
        }

        .usb-icon {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .usb-icon.connected {
            opacity: 1;
            color: var(--neon-green);
            text-shadow: var(--neon-green-intense);
        }

        .tile-status-container {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }

        .tile-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s ease;
            position: relative;
        }

        .tile-status:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: rgba(0, 20, 0, 0.9);
            color: var(--neon-green);
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
            margin-bottom: 4px;
        }

        .tile-status.connected {
            background: var(--neon-green);
            box-shadow: var(--neon-green-glow);
        }

        .tile-status.micropython {
            background: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* Main Carousel */
        .tile-carousel {
            display: flex;
            gap: 5px;
            padding: 2px 10px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            margin: 0;
            scroll-padding: 10px;
            flex-wrap: nowrap;
            height: 170px;
            min-height: 170px;
            max-height: 170px;
            align-items: flex-start;
            width: 100%;
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }

        .tile-carousel::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }

        /* Main Tiles */
        .tile {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            height: 160px;
            min-height: 160px;
            max-height: 160px;
            background-color: var(--tile-background);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-color);
            flex: 0 0 100%;
        }

        #avs-tile, #serial-tile, #ble-tile, #wifi-tile, #esp32-tile, #python-tile {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }

        #avs-tile .tile-content {
            width: 100%;
        }

        /* Tile Header Styles */
        .tile-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 10px;
            position: relative;
        }

        .tile-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tile-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 0, 0.3);
            background: rgba(0, 40, 0, 0.6);
            transition: all 0.3s ease;
        }

        .tile-icon.disconnected {
            opacity: 0.3;
            border-color: rgba(0, 255, 0, 0.1);
        }

        .tile-title-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tile-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            text-shadow: var(--neon-green-glow);
        }

        .tile-subtitle {
            font-size: 12px;
            opacity: 0.7;
            margin: 0;
        }

        .tile-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .settings-button {
            background: none;
            border: none;
            color: var(--neon-green);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            transition: all 0.3s ease;
        }

        .settings-button:hover {
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
        }

        /* Tile Color Variants */
        #wifi-tile .tile-icon,
        #wifi-tile .tile-title,
        #wifi-tile .settings-button {
            color: var(--neon-cyan);
            border-color: rgba(0, 255, 255, 0.3);
            text-shadow: var(--neon-cyan-glow);
        }

        #wifi-tile .tile-icon.disconnected {
            border-color: rgba(0, 255, 255, 0.1);
        }

        #ble-tile .tile-icon,
        #ble-tile .tile-title,
        #ble-tile .settings-button {
            color: var(--neon-blue);
            border-color: rgba(0, 136, 255, 0.3);
            text-shadow: var(--neon-blue-glow);
        }

        #ble-tile .tile-icon.disconnected {
            border-color: rgba(0, 136, 255, 0.1);
        }

        #esp32-tile .tile-icon {
            border-color: rgba(227, 24, 55, 0.3);
            background: rgba(80, 10, 20, 0.6);
            color: var(--neon-red);
        }

        #esp32-tile.detected .tile-icon {
            border-color: var(--neon-red);
            background: rgba(80, 10, 20, 0.8);
            color: var(--neon-red);
            text-shadow: var(--neon-red-intense);
        }

        #esp32-tile .tile-title {
            color: var(--neon-red);
            text-shadow: var(--neon-red-glow);
        }

        .status-icon[data-tile="esp32-tile"] {
            color: var(--neon-red);
            text-shadow: var(--neon-red-glow);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .status-icon[data-tile="esp32-tile"].connected {
            opacity: 1;
            text-shadow: 0 0 8px var(--neon-red), 0 0 12px var(--neon-red);
        }

        #python-tile .tile-icon,
        #python-tile .tile-title,
        #python-tile .settings-button {
            color: var(--neon-yellow);
            border-color: rgba(255, 212, 59, 0.3);
            text-shadow: var(--neon-yellow-glow);
        }

        #python-tile .tile-icon.disconnected {
            border-color: rgba(255, 212, 59, 0.1);
        }

        #avs-tile .tile-icon,
        #avs-tile .tile-title,
        #avs-tile .settings-button {
            color: var(--neon-green);
            border-color: rgba(0, 255, 0, 0.3);
            text-shadow: var(--neon-green-glow);
        }

        #avs-tile .tile-icon.disconnected {
            border-color: rgba(0, 255, 0, 0.1);
        }

        /* Terminal Message Colors */
        .terminal-line.wifi {
            color: var(--neon-cyan);
            text-shadow: var(--neon-cyan-glow);
        }

        .terminal-line.ble {
            color: var(--neon-blue);
            text-shadow: var(--neon-blue-glow);
        }

        .terminal-line.esp32 {
            color: var(--neon-red);
            text-shadow: var(--neon-red-glow);
        }

        .terminal-line.python {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }

        .terminal-line.avs {
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
        }

        /* Small Tiles Carousel inside MCT */
        #avs-tile .small-tile-carousel {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 100%;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            background: rgba(0, 20, 0, 0.8);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 6px;
            margin-top: 0;
            margin-bottom: 0;
        }

        #avs-tile .small-tile {
            width: 80px;
            height: 160px;
            flex: 0 0 auto;
            scroll-snap-align: start;
            scroll-snap-stop: always;
            margin-bottom: 0;
        }

        /* Connection Tiles */
        #serial-tile,
        #ble-tile,
        #wifi-tile,
        #esp32-tile,
        #python-tile {
            min-width: 300px;
            max-width: 300px;
        }

        .action-button {
            background: rgba(0, 40, 0, 0.6);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 4px;
            color: var(--neon-green);
            width: 28px;
            height: 28px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-top: 2px;
        }

        .action-button:hover {
            background: rgba(0, 136, 255, 0.2);
            box-shadow: var(--neon-blue-glow);
        }

        .action-button i {
            font-size: 14px;
        }

        .action-button.loading {
            opacity: 0.5;
            cursor: wait;
        }

        .action-button .progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: var(--neon-blue);
            box-shadow: var(--neon-blue-glow);
            transition: width 0.3s ease;
            width: 0;
        }

        .action-button.loading .progress {
            animation: progress-pulse 1s infinite;
        }

        @keyframes progress-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* ESP32 Tile Styles */
        .action-button.retry {
            background: transparent;
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .action-button.retry:hover {
            background: rgba(227, 24, 55, 0.2);
            box-shadow: 0 0 10px rgba(227, 24, 55, 0.4);
        }

        .action-button.retry i {
            margin-right: 5px;
        }

        #esp32-tile {
            transition: all 0.3s ease;
            border-color: rgba(227, 24, 55, 0.3);
            box-shadow: 0 0 10px rgba(227, 24, 55, 0.1);
        }

        #esp32-tile.detecting {
            border-color: var(--neon-red);
            box-shadow: var(--neon-red-glow);
            animation: pulse-red 1.5s infinite;
        }

        #esp32-tile.detected {
            border-color: var(--neon-red);
            box-shadow: var(--neon-red-glow);
            opacity: 1 !important;
            filter: none !important;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 10px rgba(227, 24, 55, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(227, 24, 55, 0.7);
            }
            100% {
                box-shadow: 0 0 10px rgba(227, 24, 55, 0.3);
            }
        }

        /* Status icon animation for ESP32 */
        .status-icon[data-tile="esp32-tile"].detecting {
            animation: esp-status-pulse 1s infinite;
        }

        @keyframes esp-status-pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Info text styling */
        #esp32-tile .info-row {
            margin-bottom: 1px;
            display: flex;
            font-size: 10px;
            font-family: 'Fira Code', monospace;
            line-height: 0.9;
        }

        #esp32-tile .info-section {
            padding: 4px 0;
        }

        #esp32-tile .tile-content {
            padding-top: 4px;
            padding-bottom: 4px;
        }

        #esp32-tile .info-label {
            min-width: 85px;
            font-weight: 600;
            color: var(--neon-red);
        }

        #esp32-tile .info-value {
            flex: 1;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            color: var(--neon-red);
            text-shadow: var(--neon-red-glow);
            font-family: 'Fira Code', monospace;
        }

        /* Highlight animation for tiles when their status icon is clicked */
        @keyframes highlight-pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
            }
        }

        .highlight-tile {
            animation: highlight-pulse 0.8s ease-in-out;
        }

        #wifi-tile.highlight-tile {
            animation: highlight-pulse 0.8s ease-in-out;
            animation-name: highlight-pulse-cyan !important;
        }

        #ble-tile.highlight-tile {
            animation: highlight-pulse 0.8s ease-in-out;
            animation-name: highlight-pulse-blue !important;
        }

        #esp32-tile.highlight-tile {
            animation: highlight-pulse 0.8s ease-in-out;
            animation-name: highlight-pulse-red !important;
        }

        #python-tile.highlight-tile {
            animation: highlight-pulse 0.8s ease-in-out;
            animation-name: highlight-pulse-yellow !important;
        }

        @keyframes highlight-pulse-cyan {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            }
        }

        @keyframes highlight-pulse-blue {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 136, 255, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(0, 136, 255, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 136, 255, 0.3);
            }
        }

        @keyframes highlight-pulse-red {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(227, 24, 55, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(227, 24, 55, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(227, 24, 55, 0.3);
            }
        }

        .terminal-container .terminal-copy-btn:hover {
            opacity: 1;
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
        }
        
        /* Animation for real-time parameter updates */
        @keyframes value-update-glow {
            0% { 
                text-shadow: none;
                color: inherit;
                background-color: transparent;
            }
            30% { 
                text-shadow: 0 0 8px var(--neon-red), 0 0 12px var(--neon-red);
                color: #fff;
                background-color: rgba(227, 24, 55, 0.2);
            }
            70% {
                text-shadow: 0 0 8px var(--neon-red), 0 0 12px var(--neon-red);
                color: #fff;
                background-color: rgba(227, 24, 55, 0.2);
            }
            100% { 
                text-shadow: none;
                color: inherit;
                background-color: transparent;
            }
        }
        
        .value-updated {
            animation: value-update-glow 1.2s ease-out;
            border-radius: 4px;
            padding: 0 4px;
            position: relative;
        }
        
        /* ESP32 specific animations for parameter updates */
        #esp32-tile .info-value.value-updated {
            animation: value-update-glow 1.2s ease-out;
        }
        
        /* Add progress animations for ESP32 detection */
        @keyframes detecting-pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        #esp32-tile.detecting .tile-icon i {
            animation: detecting-pulse 1s infinite;
        }

        /* Show a progress bar during detection */
        #esp32-tile.detecting::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--neon-red), transparent);
            animation: progress-scan 2s ease-in-out infinite;
            width: 30%;
            z-index: 1;
        }

        @keyframes progress-scan {
            0% { left: 0; width: 0; }
            50% { width: 30%; }
            100% { left: 100%; width: 0; }
        }
        
        /* Status bar animations */
        @keyframes highlight-pulse {
            0% { 
                transform: scale(1);
                text-shadow: var(--neon-green-glow);
            }
            50% { 
                transform: scale(1.1);
                text-shadow: var(--neon-green-intense);
            }
            100% { 
                transform: scale(1);
                text-shadow: var(--neon-green-glow);
            }
        }

        /* Detection indicator styles */
        .detection-indicator {
            display: inline-block;
            color: var(--neon-green);
            margin-right: 5px;
            animation: fade-in-out 1.5s forwards;
        }

        .detecting-now {
            display: inline-block;
            color: var(--neon-red);
            margin-right: 5px;
            animation: pulse 1s infinite;
        }

        @keyframes fade-in-out {
            0% { opacity: 0; transform: scale(0.5); }
            30% { opacity: 1; transform: scale(1.2); }
            70% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.8); }
        }

        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.7; transform: scale(0.8); }
        }

        /* Add a visual pulsing header to ESP32 tile during detection */
        #esp32-tile.detecting .tile-header {
            position: relative;
            overflow: hidden;
        }

        #esp32-tile.detecting .tile-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(227, 24, 55, 0.1), transparent);
            animation: pulse-header 1.5s infinite;
            pointer-events: none;
        }

        @keyframes pulse-header {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Improve visibility of updated values */
        #esp32-tile .info-value {
            position: relative;
            transition: all 0.3s ease;
        }

        #esp32-tile .info-value.value-updated {
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        /* ESP32 Tile Animation */
        #esp32-tile.detecting .tile-header {
            background: linear-gradient(90deg, 
                rgba(255, 0, 0, 0.1) 0%, 
                rgba(255, 0, 0, 0.4) 50%,
                rgba(255, 0, 0, 0.1) 100%);
            background-size: 200% 100%;
            animation: pulse-header 2s ease infinite;
            border-bottom: 1px solid var(--neon-red);
        }

        /* Python Tile Animation */
        #python-tile.detecting .tile-header {
            background: linear-gradient(90deg, 
                rgba(255, 255, 0, 0.1) 0%, 
                rgba(255, 255, 0, 0.4) 50%,
                rgba(255, 255, 0, 0.1) 100%);
            background-size: 200% 100%;
            animation: pulse-header 2s ease infinite;
            border-bottom: 1px solid var(--neon-yellow);
        }

        @keyframes pulse-header {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Python tile styling */
        #python-tile.detected {
            border: 1px solid var(--neon-yellow);
            box-shadow: 0 0 8px var(--neon-yellow), inset 0 0 8px var(--neon-yellow);
        }
        
        #python-tile.detected .tile-header {
            border-bottom: 1px solid var(--neon-yellow);
            box-shadow: 0 2px 4px rgba(255, 255, 0, 0.2);
        }
        
        /* Python tile compact styling to match ESP32 */
        #python-tile .endpoint-row {
            margin-bottom: 1px;
            display: flex;
            font-size: 10px;
            line-height: 0.9;
        }

        #python-tile .endpoint-info {
            padding: 4px 0;
        }

        #python-tile .tile-content {
            padding-top: 4px;
            padding-bottom: 4px;
        }

        /* Python tile specific styling */
        #python-tile.detected .endpoint-label {
            color: var(--neon-yellow);
        }
        
        #python-tile.detected .endpoint-value {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }
        
        #python-tile.detected .tile-icon i {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }
        
        #python-tile.detected .tile-title {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }
        
        @keyframes highlight-pulse-yellow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(255, 212, 59, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(255, 212, 59, 0.7);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(255, 212, 59, 0.3);
            }
        }

        /* AVS MCT tile styling when detected */
        #avs-tile.detected {
            border: 1px solid var(--neon-green);
            box-shadow: 0 0 8px var(--neon-green), inset 0 0 8px var(--neon-green);
        }
        
        #avs-tile.detected .tile-header {
            border-bottom: 1px solid var(--neon-green);
            box-shadow: 0 2px 4px rgba(0, 255, 0, 0.2);
        }
        
        #avs-tile.detected .tile-icon {
            border-color: var(--neon-green);
            color: var(--neon-green);
            text-shadow: var(--neon-green-intense);
        }

        /* ESP32 tile title fix */
        #esp32-tile .tile-title {
            max-width: 80px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        #esp32-tile .tile-header-left {
            max-width: 75%;
            overflow: hidden;
        }
        
        /* Add proper title constraints to all tiles for consistency */
        .tile-title {
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .tile-header-left {
            max-width: 75%;
            overflow: hidden;
        }

        /* REPL mode styling */
        .repl-button {
            background: rgba(255, 212, 59, 0.2);
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }
        
        .repl-button:hover {
            background: rgba(255, 212, 59, 0.3);
            box-shadow: 0 0 10px rgba(255, 212, 59, 0.4);
        }
        
        .repl-button.active {
            background: rgba(255, 212, 59, 0.4);
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-intense);
            box-shadow: 0 0 10px rgba(255, 212, 59, 0.5);
        }
        
        .terminal-container.repl-mode {
            border-top: 1px solid var(--neon-yellow);
            box-shadow: 0 -4px 10px rgba(255, 212, 59, 0.2);
        }
        
        .terminal-container.repl-mode::before {
            content: 'MicroPython REPL >>>';
            position: absolute;
            top: -20px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--neon-yellow);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-family: 'Fira Code', monospace;
            border: 1px solid var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
            z-index: 10;
        }
        
        /* Input line for REPL mode */
        #terminal-input-container {
            position: relative;
            display: none; /* Hidden by default */
            height: 30px;
            padding: 4px 8px;
            background: rgba(0, 0, 0, 0.7);
            border-top: 1px solid var(--neon-yellow);
        }
        
        #terminal-input-container.active {
            display: flex;
        }
        
        #terminal-input-prompt {
            color: var(--neon-yellow);
            font-family: 'Fira Code', monospace;
            font-size: 12px;
            margin-right: 5px;
            user-select: none;
        }
        
        #terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--neon-yellow);
            font-family: 'Fira Code', monospace;
            font-size: 12px;
        }

        /* Status bar icon color fixes for BLE and WiFi */
        .status-icon.ble-icon {
            color: var(--neon-blue) !important;
            text-shadow: var(--neon-blue-glow) !important;
        }
        .status-icon.wifi-icon {
            color: var(--neon-cyan) !important;
            text-shadow: var(--neon-cyan-glow) !important;
        }

        /* WiFi tile text color */
        #wifi-tile .endpoint-label,
        #wifi-tile .endpoint-value {
            color: var(--neon-cyan);
            text-shadow: var(--neon-cyan-glow);
        }
        /* BLE tile text color */
        #ble-tile .endpoint-label,
        #ble-tile .endpoint-value {
            color: var(--neon-blue);
            text-shadow: var(--neon-blue-glow);
        }

        .action-button.connect-btn.active {
            background: rgba(0,255,0,0.15);
            color: var(--neon-green);
            box-shadow: 0 0 8px 2px var(--neon-green);
        }
        .action-button.connect-btn.active i {
            transform: rotate(90deg);
            text-shadow: 0 0 8px var(--neon-green);
            transition: transform 0.2s;
        }
        .action-button.connect-btn i {
            transition: transform 0.2s;
        }

        .bug-icon {
            color: var(--neon-yellow);
        }
        .bug-icon:hover {
            color: var(--neon-yellow);
            text-shadow: var(--neon-yellow-glow);
        }
    </style>
</head>
<body>
    <div id="connect-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:#222; color:#0f0; padding:32px 24px; border-radius:12px; box-shadow:0 0 24px #0f0; text-align:center;">
        <h2>Connect to Device</h2>
        <p>To get started, please connect your AVS device via USB.</p>
        <button id="connect-modal-btn" style="margin-top:16px; padding:10px 24px; font-size:16px; background:#0f0; color:#111; border:none; border-radius:6px; cursor:pointer;">Connect</button>
      </div>
    </div>
    <div id="app-container">
        <!-- iPhone Status Bar -->
        <div id="iphone-status-bar">
            <div class="status-left">9:08</div>
            <div class="status-right">
                <span id="avs-icon" class="status-icon avs-icon" data-tile="avs-mcc-tile"><i class="fas fa-atom"></i></span>
                <span id="python-icon" class="status-icon python-icon" data-tile="python-tile"><i class="fa-brands fa-python"></i></span>
                <span id="esp32-icon" class="status-icon esp32-icon" data-tile="esp32-tile"><i class="fas fa-microchip"></i></span>
                <span id="wifi-icon" class="status-icon wifi-icon" data-tile="wifi-tile"><i class="fas fa-wifi"></i></span>
                <span id="ble-icon" class="status-icon ble-icon" data-tile="ble-tile"><i class="fa-brands fa-bluetooth-b"></i></span>
                <span id="usb-icon" class="status-icon usb-icon" data-tile="usb-tile"><i class="fa-brands fa-usb"></i></span>
                <a href="mct-bug.html" target="_blank" title="Report a Bug">
                    <span id="bug-icon" class="status-icon bug-icon"><i class="fas fa-bug"></i></span>
                </a>
                <div id="battery-icon" class="status-icon battery-icon" data-tile="battery-tile">
                    <div class="battery-level"></div>
                </div>
            </div>
        </div>

        <!-- Main Display -->
        <div id="main-display">
            <!-- Tiles Section -->
            <div class="tile-carousel">
                <!-- AVS Tile -->
                <div class="tile" id="avs-tile">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon">
                                <i class="fas fa-atom"></i>
                            </div>
                            <div class="tile-title-container">
                                <h3 class="tile-title">MCT</h3>
                                <p class="tile-subtitle">Molecule Control Tower</p>
                            </div>
                        </div>
                        <div class="tile-header-right">
                            <div class="header-actions">
                                <button class="action-button" id="download-files-btn" title="Download Python Files">
                                    <i class="fas fa-download"></i>
                                    <div class="progress"></div>
                                </button>
                                <button class="action-button" id="firmware-update-btn" title="Update MCT Firmware">
                                    <i class="fas fa-microchip"></i>
                                    <div class="progress-bar">
                                        <div class="progress-fill"></div>
                                        <div class="progress-text">0%</div>
                                    </div>
                                </button>
                                <button class="action-button" id="mct-test-btn" title="Run MCT Test Suite">
                                    <i class="fas fa-vial"></i>
                                    <div class="progress"></div>
                                </button>
                                <button class="action-button" id="ble-monitor-btn" title="BLE Monitoring">
                                    <i class="fas fa-chart-line"></i>
                                    <div class="progress"></div>
                                </button>
                                <button class="settings-button">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            <div class="connection-toggle" id="avs-toggle"></div>
                        </div>
                    </div>
                    <div class="tile-content">
                        <div class="small-tile-carousel">
                            <div class="small-tile">
                                <div class="tile-icon"><i class="fas fa-bolt"></i></div>
                                <div class="tile-title" style="font-size:13px;text-align:center;margin-top:8px;">Power</div>
                            </div>
                            <div class="small-tile">
                                <div class="tile-icon"><i class="fas fa-thermometer-half"></i></div>
                                <div class="tile-title" style="font-size:13px;text-align:center;margin-top:8px;">Temp</div>
                            </div>
                            <div class="small-tile">
                                <div class="tile-icon"><i class="fas fa-fan"></i></div>
                                <div class="tile-title" style="font-size:13px;text-align:center;margin-top:8px;">Fan</div>
                            </div>
                            <div class="small-tile">
                                <div class="tile-icon"><i class="fas fa-lightbulb"></i></div>
                                <div class="tile-title" style="font-size:13px;text-align:center;margin-top:8px;">Light</div>
                            </div>
                            <div class="small-tile">
                                <div class="tile-icon"><i class="fas fa-cog"></i></div>
                                <div class="tile-title" style="font-size:13px;text-align:center;margin-top:8px;">Settings</div>
                            </div>
                        </div>
                        
                        <!-- NVS Color Control Section -->
                        <div class="nvs-color-section" style="margin-top: 20px; padding: 15px; background: rgba(0, 40, 0, 0.3); border-radius: 8px; border: 1px solid rgba(0, 255, 0, 0.2);">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <span style="color: var(--neon-green); font-size: 14px; font-weight: 500;">NVS Color Control</span>
                                <div style="display: flex; gap: 8px;">
                                    <button id="read-nvs-color-btn" class="action-button" style="padding: 6px 12px; font-size: 12px;" title="Read mod.color from NVS">
                                        <i class="fas fa-download"></i> Read
                                    </button>
                                    <button id="write-nvs-color-btn" class="action-button" style="padding: 6px 12px; font-size: 12px;" title="Write mod.color to NVS">
                                        <i class="fas fa-upload"></i> Write
                                    </button>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="color" id="nvs-color-picker" style="width: 40px; height: 40px; border: 2px solid var(--neon-green); border-radius: 4px; background: none; cursor: pointer;">
                                <div style="flex: 1;">
                                    <div style="color: var(--neon-green); font-size: 12px; margin-bottom: 4px;">Current Color:</div>
                                    <div id="nvs-color-display" style="color: var(--neon-green); font-size: 11px; font-family: monospace;">#00ff00</div>
                                </div>
                            </div>
                            <div id="nvs-color-status" style="margin-top: 8px; font-size: 11px; color: var(--neon-green); opacity: 0.8;"></div>
                        </div>
                    </div>
                </div>

                <!-- Python Tile -->
                <div class="tile" id="python-tile">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon">
                                <i class="fa-brands fa-python"></i>
                            </div>
                            <div class="tile-title-container">
                                <h3 class="tile-title">Python</h3>
                            </div>
                        </div>
                        <div class="tile-header-right">
                            <button class="action-button repl-button" id="python-repl-btn" title="Access REPL Console">
                                <i class="fas fa-terminal"></i>
                            </button>
                            <button class="settings-button">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="connection-toggle" id="python-toggle"></div>
                        </div>
                    </div>
                    <div class="tile-content">
                        <div class="endpoint-info">
                            <div class="endpoint-row">
                                <span class="endpoint-label">VERSION:</span>
                                <span class="endpoint-value" id="python-version">-</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">RUNTIME:</span>
                                <span class="endpoint-value" id="python-runtime">MicroPython</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">PSRAM:</span>
                                <span class="endpoint-value" id="python-memory">ESP32-S3 8MB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ESP32 Tile -->
                <div id="esp32-tile" class="tile" style="opacity: 0.5; filter: grayscale(70%);">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon disconnected">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <h3 class="tile-title">ESP32</h3>
                        </div>
                        <button id="esp32-retry" class="action-button retry" title="Retry ESP32 Detection">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                    <div class="tile-content">
                        <div class="tile-info-container">
                            <div class="info-section esp32-info">
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">CHIP TYPE:</span>
                                    <span class="endpoint-value info-value" id="esp32-chip-type">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">FLASH:</span>
                                    <span class="endpoint-value info-value" id="esp32-flash">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">PSRAM:</span>
                                    <span class="endpoint-value info-value" id="esp32-psram">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">MAC:</span>
                                    <span class="endpoint-value info-value" id="esp32-mac">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">CHIP ID:</span>
                                    <span class="endpoint-value info-value" id="esp32-chip-id">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">FEATURES:</span>
                                    <span class="endpoint-value info-value" id="esp32-features">Unknown</span>
                                </div>
                                <div class="endpoint-row info-row">
                                    <span class="endpoint-label info-label">CRYSTAL:</span>
                                    <span class="endpoint-value info-value" id="esp32-crystal">Unknown</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WiFi Tile -->
                <div class="tile" id="wifi-tile">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon">
                                <i class="fas fa-wifi"></i>
                            </div>
                            <div class="tile-title-container">
                                <h3 class="tile-title">WiFi</h3>
                                <p class="tile-subtitle">Wireless Connection</p>
                            </div>
                        </div>
                        <div class="tile-header-right">
                            <button class="action-button connect-btn" id="wifi-connect-btn" title="Connect/Disconnect WiFi">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="action-button" id="wifi-test-btn" title="Test WiFi Bandwidth">
                                <i class="fas fa-wifi"></i>
                            </button>
                            <button class="settings-button">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="connection-toggle" id="wifi-toggle"></div>
                        </div>
                    </div>
                    <div class="tile-content">
                        <div class="endpoint-info">
                            <div class="endpoint-row">
                                <span class="endpoint-label">HOST:</span>
                                <span class="endpoint-value" id="wifi-host">mct.local</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">PORT:</span>
                                <span class="endpoint-value" id="wifi-port">5500</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BLE Tile -->
                <div class="tile" id="ble-tile">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon">
                                <i class="fa-brands fa-bluetooth-b"></i>
                            </div>
                            <div class="tile-title-container">
                                <h3 class="tile-title">Bluetooth</h3>
                                <p class="tile-subtitle">BLE Connection</p>
                            </div>
                        </div>
                        <div class="tile-header-right">
                            <button class="action-button connect-btn" id="ble-connect-btn" title="Connect/Disconnect Bluetooth">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="settings-button">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="connection-toggle" id="ble-toggle"></div>
                        </div>
                    </div>
                    <div class="tile-content">
                        <div class="endpoint-info">
                            <div class="endpoint-row">
                                <span class="endpoint-label">SERVICE:</span>
                                <span class="endpoint-value" id="ble-service">-</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">CHARACTERISTIC:</span>
                                <span class="endpoint-value" id="ble-characteristic">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Serial Connection Tile -->
                <div class="tile" id="serial-tile">
                    <div class="tile-header">
                        <div class="tile-header-left">
                            <div class="tile-icon">
                                <i class="fa-brands fa-usb"></i>
                            </div>
                            <div class="tile-title-container">
                                <h3 class="tile-title">USB</h3>
                                <p class="tile-subtitle">Serial Connection</p>
                            </div>
                        </div>
                        <div class="tile-header-right">
                            <button class="action-button connect-btn" id="serial-connect-btn" title="Connect/Disconnect USB">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="settings-button">
                                <i class="fas fa-cog"></i>
                            </button>
                            <div class="connection-toggle" id="serial-toggle"></div>
                        </div>
                    </div>
                    <div class="tile-content">
                        <div class="endpoint-info">
                            <div class="endpoint-row">
                                <span class="endpoint-label">VID:</span>
                                <span class="endpoint-value" id="serial-usb-vid">-</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">PID:</span>
                                <span class="endpoint-value" id="serial-usb-pid">-</span>
                            </div>
                            <div class="endpoint-row">
                                <span class="endpoint-label">PORT:</span>
                                <span class="endpoint-value" id="serial-usb-port">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="porthole-container">
                <div id="porthole-inner">
                    <div id="canvas-container"></div>
                </div>
            </div>

            <!-- Terminal Panel -->
            <div class="terminal-container">
                <div id="terminal-panel"></div>
                <div id="terminal-input-container">
                    <span id="terminal-input-prompt">>></span>
                    <input type="text" id="terminal-input" placeholder="Enter MicroPython command...">
                </div>
                <button class="terminal-copy-btn" title="Copy terminal output">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
        import { CSS3DRenderer, CSS3DObject } from 'three/examples/jsm/renderers/CSS3DRenderer';
        import { ESPLoader, Transport } from 'esptool-js';
        // Import everything from serial-manager.js in one go to avoid naming conflicts
        import * as SerialManager from './js/serial-manager.js';
        
        // Aliases for imported functionality
        const USBManager = SerialManager.USBManager;
        const logToTerminal = SerialManager.logToTerminal;
        const updateConnectionStatus = SerialManager.updateConnectionStatus;
        const connectionState = SerialManager.connectionState;
        
        // Feature detection
        const hasWebSerial = 'serial' in navigator;
        const hasWebBluetooth = 'bluetooth' in navigator;
        const hasBLEScan = hasWebBluetooth && 'requestLEScan' in navigator.bluetooth;
        
        // Initialize UI
        function initializeUI() {
            // Gray out conditional elements
            const esp32Tile = document.getElementById('esp32-tile');
            const esp32Icon = document.getElementById('esp32-icon');
            const pythonTile = document.getElementById('python-tile');
            const pythonIcon = document.getElementById('python-icon');
            const wifiIcon = document.getElementById('wifi-icon');
            const bleIcon = document.getElementById('ble-icon');

            if (esp32Tile) esp32Tile.style.opacity = '0.5';
            if (esp32Icon) esp32Icon.style.opacity = '0.3';
            if (pythonTile) pythonTile.style.opacity = '0.5';
            if (pythonIcon) pythonIcon.style.opacity = '0.3';
            if (wifiIcon) {
                wifiIcon.classList.remove('connected');
                wifiIcon.style.opacity = '0.3';
            }
            if (bleIcon) {
                bleIcon.classList.remove('connected');
                bleIcon.style.opacity = '0.3';
            }
            // Set up status bar icon click handlers
            setupStatusIconClickHandlers();
            
            // Set up ESP32 retry button
            const esp32RetryBtn = document.getElementById('esp32-retry');
            if (esp32RetryBtn) {
                esp32RetryBtn.addEventListener('click', async () => {
                    if (connectionState.usb && USBManager.currentPort) {
                        // Update button state
                        esp32RetryBtn.disabled = true;
                        esp32RetryBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
                        
                        // Reset ESP32 status
                        if (esp32Tile) {
                            esp32Tile.classList.remove('detected');
                            esp32Tile.classList.add('detecting');
                            esp32Tile.style.opacity = '0.8';
                        }
                        
                        if (esp32Icon) {
                            esp32Icon.classList.remove('connected');
                            esp32Icon.classList.add('detecting');
                            esp32Icon.style.opacity = '0.7';
                            esp32Icon.style.color = 'var(--neon-red)';
                        }
                        
                        // Call ESP32 detection
                        logToTerminal('Retrying ESP32 detection...', false, 'esp32');
                        await USBManager.detectESP32(USBManager.currentPort);
                        
                        // Reset button state
                        esp32RetryBtn.disabled = false;
                        esp32RetryBtn.innerHTML = '<i class="fas fa-redo"></i>';
                    } else {
                        logToTerminal('Cannot retry ESP32 detection: No USB connection', true, 'esp32');
                    }
                });
            }

            // Add event handler for USB tile settings button
            const usbSettingsBtn = document.querySelector('#serial-tile .settings-button');
            if (usbSettingsBtn) {
                usbSettingsBtn.addEventListener('click', () => {
                    alert('USB settings coming soon!');
                });
            }
        }

        // Function to setup all status icon click handlers
        function setupStatusIconClickHandlers() {
            // Icons and their corresponding tiles
            const iconTileMappings = {
                '.status-icon.wifi-icon': '#wifi-tile',
                '.status-icon.ble-icon': '#ble-tile',
                '.status-icon.usb-icon': '#usb-tile',
                '.status-icon.esp32-icon': '#esp32-tile',
                '.status-icon.python-icon': '#python-tile',
                '.status-icon.avs-icon': '#avs-tile',
                '.status-icon.battery-icon': '#battery-tile' // If you have a battery tile
            };

            // Add click handlers to all status icons
            for (const [iconSelector, tileSelector] of Object.entries(iconTileMappings)) {
                const icon = document.querySelector(iconSelector);
                const tile = document.querySelector(tileSelector);
                
                if (icon && tile) {
                    // Extract tile name for the tooltip
                    const tileName = tileSelector.replace('#', '').replace('-tile', '').toUpperCase();
                    
                    // Set tooltip
                    icon.title = `Scroll to ${tileName} Tile`;
                    
                    // Add click handler
                    icon.addEventListener('click', () => {
                        // Scroll to the associated tile
                        tile.scrollIntoView({ behavior: 'smooth' });
                        
                        // Add highlight animation
                        tile.classList.add('highlight-tile');
                        
                        // Remove the highlight class after animation completes
                        setTimeout(() => {
                            tile.classList.remove('highlight-tile');
                        }, 800);
                    });
                    
                    // Make sure the icon is styled as clickable
                    icon.style.cursor = 'pointer';
                }
            }
        }

        // Call initialization on load
        document.addEventListener('DOMContentLoaded', initializeUI);

        // Toggle serial connection
        async function toggleSerialConnection() {
            const toggle = document.getElementById('serial-toggle');
            if (!toggle) return;

            try {
                if (toggle.classList.contains('active')) {
                    // Disconnect
                    try {
                        const ports = await navigator.serial.getPorts();
                        if (ports.length > 0) {
                            await USBManager.cleanupPort(ports[0]);
                            toggle.classList.remove('active');
                            updateConnectionStatus(false, 'serial');
                            updateConnectionStatus(false, 'esp32');
                            updateConnectionStatus(false, 'python');
                            logToTerminal('USB disconnected', false, 'serial');
                        }
                    } catch (error) {
                        logToTerminal(`USB disconnect failed: ${error.message}`, true, 'serial');
                    }
                } else {
                    // Connect
                    try {
                        logToTerminal('Connecting to USB device...', false, 'serial');
                        const port = await navigator.serial.requestPort({
                            filters: [
                                // Current device
                                { usbVendorId: 0x303a, usbProductId: 0x0420 },
                                // Additional supported device
                                { usbVendorId: 0x3031, usbProductId: 0x0420 }
                            ]
                        });
                        
                        // Update UI to show pending connection
                        const usbIcon = document.getElementById('usb-icon');
                        if (usbIcon) {
                            usbIcon.style.opacity = '0.6';
                            usbIcon.style.color = 'var(--neon-green)';
                            usbIcon.classList.add('connecting');
                        }
                        
                        // Let the ESP32 detection happen within connectToPort
                        // This new flow interrogates ESP32 before finalizing the connection
                        const connected = await USBManager.connectToPort(port);
                        
                        if (connected) {
                            toggle.classList.add('active');
                            logToTerminal('USB connected and device interrogated successfully', false, 'serial');
                            
                            // Ensure USB icon is properly lit
                            if (usbIcon) {
                                usbIcon.classList.remove('connecting');
                                usbIcon.classList.add('connected');
                                usbIcon.style.opacity = '1';
                                usbIcon.style.color = 'var(--neon-green)';
                                usbIcon.style.textShadow = 'var(--neon-green-intense)';
                            }
                            
                            // Before ESP32 detection (after port open):
                            updateConnectionStatus(true, 'usb');
                            // ... ESP32 detection logic ...
                            // Before Python detection (if separate):
                            updateConnectionStatus(true, 'usb');
                            // ... Python detection logic ...
                            // After disconnect/cleanup/close:
                            updateConnectionStatus(false, 'usb');
                            
                            // After successfully connecting, also check for AVS MCT
                            if (USBManager.currentPort) {
                                logToTerminal('Checking for MCT...');
                                setTimeout(async () => {
                                    try {
                                        const mcResult = await USBManager.checkPython(USBManager.currentPort);
                                        if (!mcResult) {
                                            logToTerminal('No MicroPython detected, MCT may not be available', false, 'avs');
                                        }
                                    } catch (mcError) {
                                        console.error('MCT check error:', mcError);
                                    }
                                }, 500);
                            }
                        } else {
                            throw new Error('Connection failed');
                        }
                    } catch (error) {
                        toggle.classList.remove('active');
                        
                        // Reset USB icon
                        const usbIcon = document.getElementById('usb-icon');
                        if (usbIcon) {
                            usbIcon.classList.remove('connecting');
                            usbIcon.style.opacity = '0.3';
                        }
                        
                        logToTerminal(`USB connect failed: ${error.message}`, true, 'serial');
                    }
                }
            } catch (error) {
                logToTerminal(`USB operation failed: ${error.message}`, true);
                // Ensure clean state on error
                updateConnectionStatus(false, 'serial');
                updateConnectionStatus(false, 'esp32');
                updateConnectionStatus(false, 'python');
            }
        }

        // Initialize 3D Portal
        function init3DPortal() {
            const container = document.getElementById('canvas-container');
            if (!container) return;
            
            // Clear any existing content
            container.innerHTML = '';
            
            // Create iframe to load mct.html
            const iframe = document.createElement('iframe');
            iframe.src = 'mct.html';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '8px';
            iframe.style.backgroundColor = 'transparent';
            
            // Add iframe to container
            container.appendChild(iframe);
            
            // Log success
            logToTerminal('3D portal loaded', false, 'avs');
        }
        
        // Initialize 3D portal when document is loaded
        init3DPortal();

        // Add event listener to toggle USB connection manually
        document.getElementById('serial-toggle').addEventListener('click', toggleSerialConnection);
        
        // Add click handler for USB icon to scroll to serial tile
        document.getElementById('usb-icon').addEventListener('click', () => {
            const serialTile = document.getElementById('serial-tile');
            if (serialTile) {
                serialTile.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Add event listener for ESP32 retry button
        document.getElementById('esp32-retry').addEventListener('click', async () => {
            try {
                const retryButton = document.getElementById('esp32-retry');
                if (!retryButton) return;
                
                // Disable button and show loading state
                retryButton.disabled = true;
                retryButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
                
                logToTerminal('Retrying ESP32 detection...', false, 'esp32');
                
                // First check if we need to release existing readers/writers
                logToTerminal('Preparing for ESP32 detection retry...', false, 'esp32');
                
                // Get the active port from navigator.serial
                const ports = await navigator.serial.getPorts();
                if (ports.length === 0) {
                    logToTerminal('No active port available for ESP32 detection', true, 'esp32');
                    return;
                }
                
                // Let the USBManager handle the detection with proper error handling
                try {
                    const result = await USBManager.detectESP32(ports[0]);
                    if (result) {
                        logToTerminal('ESP32 detection retry successful!', false, 'esp32');
                    } else {
                        logToTerminal('ESP32 detection retry did not succeed', true, 'esp32');
                    }
                } catch (detectionError) {
                    logToTerminal(`ESP32 detection error: ${detectionError.message}`, true, 'esp32');
                    
                    // If we have a locked stream error, provide more helpful information
                    if (detectionError.message.includes('locked') || 
                        detectionError.message.includes('getReader') || 
                        detectionError.message.includes('getWriter')) {
                        
                        logToTerminal('Stream locking issue detected. Try refreshing the page and reconnecting.', true, 'esp32');
                        
                        // Add a helper button to refresh the page if it doesn't exist
                        if (!document.getElementById('refresh-page-btn')) {
                            const refreshBtn = document.createElement('button');
                            refreshBtn.id = 'refresh-page-btn';
                            refreshBtn.className = 'neon-button blue';
                            refreshBtn.textContent = 'Refresh Page';
                            refreshBtn.style.marginTop = '10px';
                            refreshBtn.addEventListener('click', () => {
                                window.location.reload();
                            });
                            
                            const esp32Tile = document.getElementById('esp32-tile');
                            if (esp32Tile) {
                                esp32Tile.appendChild(refreshBtn);
                            }
                        }
                    }
                }
                
            } catch (error) {
                logToTerminal(`ESP32 retry error: ${error.message}`, true, 'esp32');
            } finally {
                // Reset button state
                const retryButton = document.getElementById('esp32-retry');
                if (retryButton) {
                    retryButton.disabled = false;
                    retryButton.innerHTML = '<i class="fas fa-redo"></i>';
                }
            }
        });

        // Initialize serial manager - do this only once
        USBManager.autoConnectToStoredPorts().then(async (connected) => {
            if (connected) {
                // Make sure USB icon is properly lit
                const usbIcon = document.getElementById('usb-icon');
                if (usbIcon) {
                    usbIcon.classList.add('connected');
                    usbIcon.style.opacity = '1';
                    usbIcon.style.color = 'var(--neon-green)';
                    usbIcon.style.textShadow = 'var(--neon-green-intense)';
                }
                
                // Make sure toggle is active
                const toggle = document.getElementById('serial-toggle');
                if (toggle) {
                    toggle.classList.add('active');
                }
                
                logToTerminal('Successfully connected to stored port', false, 'serial');
                // After ESP32 detection, disconnect the port
                if (USBManager.currentPort) {
                    try {
                        await USBManager.cleanupPort(USBManager.currentPort);
                        await USBManager.currentPort.close();
                        logToTerminal('Port disconnected after ESP32 detection', false, 'serial');
                        updateConnectionStatus(false, 'serial');
                    } catch (e) {
                        logToTerminal('Error disconnecting port after ESP32 detection: ' + (e.message || e), true, 'serial');
                    }
                }
                // After ESP32 and Python detection, disconnect the port
                if (USBManager.currentPort) {
                    try {
                        await USBManager.cleanupPort(USBManager.currentPort);
                        await USBManager.currentPort.close();
                        logToTerminal('Port disconnected after Python check', false, 'serial');
                        updateConnectionStatus(false, 'serial');
                    } catch (e) {
                        logToTerminal('Error disconnecting port after Python check: ' + (e.message || e), true, 'serial');
                    }
                }
            } else {
                // Show connect modal if no ports found
                const modal = document.getElementById('connect-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    const btn = document.getElementById('connect-modal-btn');
                    btn.onclick = async () => {
                        try {
                            await USBManager.manualConnect();
                            modal.style.display = 'none';
                        } catch (e) {
                            alert('Failed to connect: ' + e.message);
                        }
                    };
                }
            }
        }).catch(error => {
            logToTerminal(`Error during auto-connect: ${error.message}`, true);
        });

        document.getElementById('download-files-btn').addEventListener('click', () => {
            alert('Download Python Files: This feature is not yet implemented.');
        });

        // WebREPL functionality for Python REPL button
        let replMode = false;
        let replTerminal = null;
        let replSocket = null;
        
        document.getElementById('python-repl-btn').addEventListener('click', async () => {
            const replBtn = document.getElementById('python-repl-btn');
            const pythonTile = document.getElementById('python-tile');
            const terminalContainer = document.querySelector('.terminal-container');
            const terminalPanel = document.getElementById('terminal-panel');
            const terminalInputContainer = document.getElementById('terminal-input-container');
            const terminalInput = document.getElementById('terminal-input');
            
            // Check if Python tile is active
            if (!pythonTile || !pythonTile.classList.contains('detected')) {
                alert('Please connect to MicroPython first');
                return;
            }
            
            // Toggle REPL mode
            replMode = !replMode;
            
            if (replMode) {
                // Get device IP from WiFi tile if available
                const wifiSSID = document.getElementById('wifi-ssid')?.textContent;
                const wifiIP = document.getElementById('wifi-ip')?.textContent;
                
                // Check if we should use WebREPL or USB Serial REPL
                const useWebREPL = wifiIP && wifiIP !== '-' && wifiSSID && wifiSSID !== '-';
                
                if (!useWebREPL) {
                    // Use USB Serial REPL fallback
                    const port = window.USBManager?.currentPort;
                    if (!port) {
                        alert('No USB connection available. Please connect via USB or ensure WiFi is connected for WebREPL.');
                        replMode = false;
                        return;
                    }
                    
                    // Activate REPL mode UI
                    replBtn.classList.add('active');
                    terminalContainer.classList.add('repl-mode');
                    terminalInputContainer.classList.add('active');
                    
                    // Clear terminal and show connection message
                    terminalPanel.innerHTML = '';
                    logToTerminal('Entering USB Serial REPL mode...', false, 'python');
                    logToTerminal('Type Python commands and press Enter. Use Ctrl-C to interrupt.', false, 'python');
                    
                    // Focus on input
                    terminalInput.focus();
                    
                    // Mark as USB REPL mode
                    window.usbReplMode = true;
                    
                    return;
                }
                
                // Activate REPL mode UI
                replBtn.classList.add('active');
                terminalContainer.classList.add('repl-mode');
                terminalInputContainer.classList.add('active');
                
                // Clear terminal and show connection message
                terminalPanel.innerHTML = '';
                logToTerminal(`Connecting to WebREPL at ws://${wifiIP}:420...`, false, 'python');
                
                try {
                    // Create WebSocket connection to MCT WebREPL on port 420
                    replSocket = new WebSocket(`ws://${wifiIP}:420`);
                    replSocket.binaryType = 'arraybuffer';
                    
                    replSocket.onopen = () => {
                        logToTerminal('WebREPL connected!', false, 'python');
                        logToTerminal('Enter password to authenticate...', false, 'python');
                        terminalInput.focus();
                    };
                    
                    replSocket.onmessage = (event) => {
                        if (event.data instanceof ArrayBuffer) {
                            // Handle binary WebSocket frames
                            const view = new DataView(event.data);
                            const frameType = view.getUint8(0);
                            const payloadLength = view.getUint8(1);
                            
                            if (frameType === 0x81) { // Text frame
                                const decoder = new TextDecoder();
                                const text = decoder.decode(new Uint8Array(event.data, 2, payloadLength));
                                
                                // Display in terminal with proper formatting
                                const lines = text.split('\\n');
                                lines.forEach(line => {
                                    if (line.trim()) {
                                        const lineElement = document.createElement('div');
                                        lineElement.className = 'terminal-line python';
                                        lineElement.textContent = line;
                                        terminalPanel.appendChild(lineElement);
                                    }
                                });
                                
                                // Auto-scroll to bottom
                                terminalPanel.scrollTop = terminalPanel.scrollHeight;
                            }
                        } else {
                            // Handle text messages
                            const text = event.data;
                            logToTerminal(text, false, 'python');
                        }
                    };
                    
                    replSocket.onerror = (error) => {
                        logToTerminal(`WebREPL error: ${error}`, true, 'python');
                    };
                    
                    replSocket.onclose = () => {
                        logToTerminal('WebREPL disconnected', false, 'python');
                        // Clean up UI
                        replBtn.classList.remove('active');
                        terminalContainer.classList.remove('repl-mode');
                        terminalInputContainer.classList.remove('active');
                        replMode = false;
                        replSocket = null;
                    };
                    
                } catch (error) {
                    logToTerminal(`Failed to connect to WebREPL: ${error.message}`, true, 'python');
                    replMode = false;
                }
                
            } else {
                // Deactivate REPL mode
                if (replSocket) {
                    replSocket.close();
                }
                if (window.usbReplMode) {
                    window.usbReplMode = false;
                    logToTerminal('Exited USB Serial REPL mode', false, 'python');
                } else {
                    logToTerminal('Exited WebREPL mode', false, 'python');
                }
                replBtn.classList.remove('active');
                terminalContainer.classList.remove('repl-mode');
                terminalInputContainer.classList.remove('active');
            }
        });
        
        // Handle terminal input for REPL (both WebREPL and USB Serial)
        document.getElementById('terminal-input').addEventListener('keypress', async (event) => {
            if (event.key === 'Enter' && replMode) {
                const input = event.target.value;
                event.target.value = '';
                
                if (window.usbReplMode) {
                    // USB Serial REPL mode
                    const port = window.USBManager?.currentPort;
                    if (port && port.writable) {
                        try {
                            const writer = port.writable.getWriter();
                            const encoder = new TextEncoder();
                            
                            // Send the command
                            await writer.write(encoder.encode(input + '\r\n'));
                            writer.releaseLock();
                            
                            // Echo command in terminal
                            logToTerminal(`>>> ${input}`, false, 'python');
                            
                            // Read response
                            if (port.readable) {
                                const reader = port.readable.getReader();
                                setTimeout(async () => {
                                    try {
                                        const { value, done } = await reader.read();
                                        if (!done && value) {
                                            const response = new TextDecoder().decode(value);
                                            logToTerminal(response, false, 'python');
                                        }
                                        reader.releaseLock();
                                    } catch (e) {
                                        console.error('Error reading REPL response:', e);
                                    }
                                }, 100);
                            }
                        } catch (error) {
                            logToTerminal(`Error sending command: ${error.message}`, true, 'python');
                        }
                    }
                } else if (replSocket && replSocket.readyState === WebSocket.OPEN) {
                    // WebREPL mode
                    // Send command to WebREPL (text frame format)
                    const encoder = new TextEncoder();
                    const data = encoder.encode(input + '\r\n');
                    const frame = new Uint8Array(2 + data.length);
                    frame[0] = 0x81; // Text frame
                    frame[1] = data.length;
                    frame.set(data, 2);
                    
                    replSocket.send(frame);
                    
                    // Echo command in terminal
                    logToTerminal(`>>> ${input}`, false, 'python');
                }
            }
        });
        
        // Add Ctrl-C handler for interrupting running programs
        document.getElementById('terminal-input').addEventListener('keydown', async (event) => {
            if (event.ctrlKey && event.key === 'c' && replMode && window.usbReplMode) {
                event.preventDefault();
                const port = window.USBManager?.currentPort;
                if (port && port.writable) {
                    try {
                        const writer = port.writable.getWriter();
                        await writer.write(new Uint8Array([0x03])); // Ctrl-C
                        writer.releaseLock();
                        logToTerminal('^C', false, 'python');
                    } catch (error) {
                        console.error('Error sending Ctrl-C:', error);
                    }
                }
            }
        });
        document.getElementById('firmware-update-btn').addEventListener('click', async () => {
            let port = window.USBManager?.currentPort;
            if (port) {
                try { await window.USBManager.cleanupPort(port); } catch (e) {}
                try { await port.close(); } catch (e) {}
                window.USBManager.currentPort = null;
                if (window.activePort) window.activePort = null;
            }
            await new Promise(resolve => setTimeout(resolve, 1000));
            const openPorts = await navigator.serial.getPorts();
            if (openPorts.length > 0) {
                alert('A serial port is still open. Please close all serial connections or reload the page before flashing.');
                return;
            }
            window.open('esptool.html', '_blank');
        });

        // --- MCT Test Button Logic ---
        document.getElementById('mct-test-btn').addEventListener('click', async () => {
            // Only allow if Python tile is active
            const pythonTile = document.getElementById('python-tile');
            if (!pythonTile || !pythonTile.classList.contains('detected')) {
                alert('Please connect to MicroPython (Python tile must be active) before running the MCT test.');
                return;
            }
            
            // Use the same port as Python tile
            const port = window.USBManager?.currentPort;
            if (!port) {
                alert('No device connected! Please reconnect using the Python tile.');
                return;
            }

            // Show test options
            const testType = prompt('Select test type:\n1. auto (comprehensive)\n2. manual (interactive)\n3. performance (benchmark)\n\nEnter 1, 2, or 3:', '1');
            if (!testType) return;
            
            let testMode = 'auto';
            if (testType === '2') testMode = 'manual';
            else if (testType === '3') testMode = 'performance';
            
            logToTerminal(`🧪 Starting MCT test suite (${testMode} mode)...`, false, 'avs');
            
            // Create the test script
            const testScript = `
import json
import time
from MCT import MCT

print("🧪 MCT Test Suite Starting...")
print(f"Test Mode: {testMode}")
print("=" * 50)

try:
    # Create MCT instance
    print("Creating MCT instance...")
    mct = MCT()
    print("✅ MCT instance created successfully")
    
    # Run the test
    print(f"Running {testMode} test...")
    start_time = time.ticks_ms()
    
    if hasattr(mct, 'test'):
        # Use the new simplified test method
        result = mct.test()
        print("✅ Test completed successfully")
        print("Test result:", result)
    else:
        # Fallback to comprehensive test
        print("Using comprehensive test fallback...")
        from MCT_TEST import MCT_TEST
        tester = MCT_TEST(mct)
        result = tester.comprehensive_test(testMode)
        print("✅ Comprehensive test completed")
    
    end_time = time.ticks_ms()
    duration = time.ticks_diff(end_time, start_time) / 1000
    
    print(f"\\nTest completed in {duration:.2f} seconds")
    print("=" * 50)
    print("🎉 MCT Test Suite Finished!")
    
except Exception as e:
    print(f"❌ Test failed with error: {e}")
    import sys
    sys.print_exception(e)
    print("=" * 50)
    print("💥 MCT Test Suite Failed!")
`;

            // Send the test script to the device via MicroPython REPL
            try {
                const writer = port.writable.getWriter();
                
                // Send Ctrl-C to interrupt any running code
                await writer.write(new TextEncoder().encode("\x03\r\n"));
                await new Promise(r => setTimeout(r, 100));
                
                // Send the test script
                await writer.write(new TextEncoder().encode(testScript + "\r\n"));
                writer.releaseLock();
                
                logToTerminal('MCT test script sent and running! Check the terminal for results.', false, 'avs');
                
            } catch (err) {
                logToTerminal(`Failed to send MCT test script: ${err.message || err}`, true, 'avs');
                alert('Failed to send test script: ' + (err.message || err));
            }
        });

        // --- NVS Color Control Logic ---
        const nvsColorPicker = document.getElementById('nvs-color-picker');
        const nvsColorDisplay = document.getElementById('nvs-color-display');
        const nvsColorStatus = document.getElementById('nvs-color-status');
        const readNvsColorBtn = document.getElementById('read-nvs-color-btn');
        const writeNvsColorBtn = document.getElementById('write-nvs-color-btn');

        // Initialize color picker with current mod color
        nvsColorPicker.value = localStorage.getItem('modColor') || '#00ff00';
        nvsColorDisplay.textContent = nvsColorPicker.value;

        // Update display when color picker changes
        nvsColorPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            nvsColorDisplay.textContent = color;
        });

        // Read mod.color from NVS
        readNvsColorBtn.addEventListener('click', async () => {
            // Only allow if Python tile is active
            const pythonTile = document.getElementById('python-tile');
            if (!pythonTile || !pythonTile.classList.contains('detected')) {
                alert('Please connect to MicroPython (Python tile must be active) before reading from NVS.');
                return;
            }
            
            const port = window.USBManager?.currentPort;
            if (!port) {
                alert('No device connected! Please reconnect using the Python tile.');
                return;
            }

            nvsColorStatus.textContent = 'Reading from NVS...';
            
            try {
                const writer = port.writable.getWriter();
                
                // Send Ctrl-C to interrupt any running code
                await writer.write(new TextEncoder().encode("\x03\r\n"));
                await new Promise(r => setTimeout(r, 100));
                
                // Send the read script
                const readScript = `
import nvs
try:
    color = nvs.get_nvs('mod.color')
    if color:
        print(f"NVS_COLOR_READ_SUCCESS:{color}")
    else:
        print("NVS_COLOR_READ_NONE")
except Exception as e:
    print(f"NVS_COLOR_READ_ERROR:{e}")
`;
                
                await writer.write(new TextEncoder().encode(readScript + "\r\n"));
                writer.releaseLock();
                
                // Listen for the response
                const reader = port.readable.getReader();
                let response = '';
                let timeout = setTimeout(() => {
                    reader.releaseLock();
                    nvsColorStatus.textContent = 'Read timeout - no response from device';
                }, 5000);
                
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        response += new TextDecoder().decode(value);
                        
                        if (response.includes('NVS_COLOR_READ_SUCCESS:')) {
                            clearTimeout(timeout);
                            const match = response.match(/NVS_COLOR_READ_SUCCESS:(.+)/);
                            if (match) {
                                const color = match[1].trim();
                                nvsColorPicker.value = color;
                                nvsColorDisplay.textContent = color;
                                nvsColorStatus.textContent = `Read successfully: ${color}`;
                                
                                // Update the mod color in the UI
                                document.documentElement.style.setProperty('--mod-color', color);
                                localStorage.setItem('modColor', color);
                                const avsTile = document.getElementById('avs-tile');
                                if (avsTile) {
                                    avsTile.style.boxShadow = `0 0 16px 4px ${color}, 0 0 32px 8px ${color}55`;
                                    avsTile.style.borderColor = color;
                                }
                            }
                            break;
                        } else if (response.includes('NVS_COLOR_READ_NONE')) {
                            clearTimeout(timeout);
                            nvsColorStatus.textContent = 'No color found in NVS';
                            break;
                        } else if (response.includes('NVS_COLOR_READ_ERROR:')) {
                            clearTimeout(timeout);
                            const match = response.match(/NVS_COLOR_READ_ERROR:(.+)/);
                            if (match) {
                                nvsColorStatus.textContent = `Read error: ${match[1].trim()}`;
                            }
                            break;
                        }
                    }
                } finally {
                    reader.releaseLock();
                }
                
            } catch (err) {
                nvsColorStatus.textContent = `Failed to read from NVS: ${err.message || err}`;
                console.error('NVS read error:', err);
            }
        });

        // Write mod.color to NVS
        writeNvsColorBtn.addEventListener('click', async () => {
            // Only allow if Python tile is active
            const pythonTile = document.getElementById('python-tile');
            if (!pythonTile || !pythonTile.classList.contains('detected')) {
                alert('Please connect to MicroPython (Python tile must be active) before writing to NVS.');
                return;
            }
            
            const port = window.USBManager?.currentPort;
            if (!port) {
                alert('No device connected! Please reconnect using the Python tile.');
                return;
            }

            const color = nvsColorPicker.value;
            nvsColorStatus.textContent = 'Writing to NVS...';
            
            try {
                const writer = port.writable.getWriter();
                
                // Send Ctrl-C to interrupt any running code
                await writer.write(new TextEncoder().encode("\x03\r\n"));
                await new Promise(r => setTimeout(r, 100));
                
                // Send the write script
                const writeScript = `
import nvs
try:
    result = nvs.set_nvs('mod.color', '${color}')
    if result:
        print("NVS_COLOR_WRITE_SUCCESS")
    else:
        print("NVS_COLOR_WRITE_FAILED")
except Exception as e:
    print(f"NVS_COLOR_WRITE_ERROR:{e}")
`;
                
                await writer.write(new TextEncoder().encode(writeScript + "\r\n"));
                writer.releaseLock();
                
                // Listen for the response
                const reader = port.readable.getReader();
                let response = '';
                let timeout = setTimeout(() => {
                    reader.releaseLock();
                    nvsColorStatus.textContent = 'Write timeout - no response from device';
                }, 5000);
                
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        
                        response += new TextDecoder().decode(value);
                        
                        if (response.includes('NVS_COLOR_WRITE_SUCCESS')) {
                            clearTimeout(timeout);
                            nvsColorStatus.textContent = `Written successfully: ${color}`;
                            
                            // Update the mod color in the UI
                            document.documentElement.style.setProperty('--mod-color', color);
                            localStorage.setItem('modColor', color);
                            const avsTile = document.getElementById('avs-tile');
                            if (avsTile) {
                                avsTile.style.boxShadow = `0 0 16px 4px ${color}, 0 0 32px 8px ${color}55`;
                                avsTile.style.borderColor = color;
                            }
                            break;
                        } else if (response.includes('NVS_COLOR_WRITE_FAILED')) {
                            clearTimeout(timeout);
                            nvsColorStatus.textContent = 'Write failed';
                            break;
                        } else if (response.includes('NVS_COLOR_WRITE_ERROR:')) {
                            clearTimeout(timeout);
                            const match = response.match(/NVS_COLOR_WRITE_ERROR:(.+)/);
                            if (match) {
                                nvsColorStatus.textContent = `Write error: ${match[1].trim()}`;
                            }
                            break;
                        }
                    }
                } finally {
                    reader.releaseLock();
                }
                
            } catch (err) {
                nvsColorStatus.textContent = `Failed to write to NVS: ${err.message || err}`;
                console.error('NVS write error:', err);
            }
        });

        // --- Modal Color Picker for MCT ---
        // Add modal HTML to the body if not present
        if (!document.getElementById('mod-color-modal')) {
            const modal = document.createElement('div');
            modal.id = 'mod-color-modal';
            modal.style.display = 'none';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10001';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.innerHTML = `
              <div id="mod-color-modal-content" style="background:#222;padding:32px 24px;border-radius:16px;box-shadow:0 0 32px var(--mod-color,#0f0);display:flex;flex-direction:column;align-items:center;">
                <label style="color:var(--mod-color,#0f0);font-size:18px;margin-bottom:12px;">Pick Mod Color</label>
                <input type="color" id="mod-color-picker" style="width:80px;height:80px;border:none;box-shadow:0 0 16px var(--mod-color,#0f0);margin-bottom:16px;">
                <button id="mod-color-close" style="padding:8px 24px;border-radius:8px;background:var(--mod-color,#0f0);color:#111;font-weight:bold;border:none;cursor:pointer;">Close</button>
              </div>
            `;
            document.body.appendChild(modal);
        }
        const modColorModal = document.getElementById('mod-color-modal');
        const modColorPicker = document.getElementById('mod-color-picker');
        const modColorClose = document.getElementById('mod-color-close');
        // Set initial value
        modColorPicker.value = localStorage.getItem('modColor') || '#00ff00';
        // Show modal on settings click
        const avsSettingsBtn = document.querySelector('#avs-tile .settings-button');
        if (avsSettingsBtn) {
            avsSettingsBtn.addEventListener('click', () => {
                modColorModal.style.display = 'flex';
                modColorPicker.focus();
            });
        }
        // Hide modal on close or backdrop click
        modColorClose.addEventListener('click', () => { modColorModal.style.display = 'none'; });
        modColorModal.addEventListener('click', (e) => {
            if (e.target === modColorModal) modColorModal.style.display = 'none';
        });
        // Update color on input
        modColorPicker.addEventListener('input', (e) => {
            const color = e.target.value;
            document.documentElement.style.setProperty('--mod-color', color);
            localStorage.setItem('modColor', color);
            const avsTile = document.getElementById('avs-tile');
            if (avsTile) {
                avsTile.style.boxShadow = `0 0 16px 4px ${color}, 0 0 32px 8px ${color}55`;
                avsTile.style.borderColor = color;
            }
            // Send color to 3D portal iframe (mct.html) if ready
            const portalIframe = document.querySelector('#canvas-container iframe');
            if (mctReady && portalIframe && portalIframe.contentWindow) {
                console.log('[MCC] Sending color to mct:', color);
                portalIframe.contentWindow.postMessage({ type: 'set-mct-color', color }, '*');
            } else {
                console.log('[MCC] mct.html not ready, not sending color');
            }
        });
        // On page load, apply the saved mod color
        const savedModColor = localStorage.getItem('modColor');
        if (savedModColor) {
            document.documentElement.style.setProperty('--mod-color', savedModColor);
            const avsTile = document.getElementById('avs-tile');
            if (avsTile) {
                avsTile.style.boxShadow = `0 0 16px 4px ${savedModColor}, 0 0 32px 8px ${savedModColor}55`;
                avsTile.style.borderColor = savedModColor;
            }
        }
        // --- Improved WiFi Test Button Logic ---
        document.getElementById('wifi-test-btn').addEventListener('click', async () => {
            // Only allow if Python tile is active
            const pythonTile = document.getElementById('python-tile');
            if (!pythonTile || !pythonTile.classList.contains('detected')) {
                alert('Please connect to MicroPython (Python tile must be active) before running the WiFi test.');
                return;
            }
            // Use the same port as Python tile
            const port = window.USBManager?.currentPort;
            if (!port) {
                alert('No device connected! Please reconnect using the Python tile.');
                return;
            }
            // Prompt for WiFi credentials
            const ssid = prompt('Enter WiFi SSID:');
            if (!ssid) return;
            const password = prompt('Enter WiFi Password:');
            if (password === null) return;
            // Generate the script with improved error handling and timeout
            const script = `\nimport network\nimport socket\nimport time\n\nssid = "${ssid}"\npassword = "${password}"\n\nwlan = network.WLAN(network.STA_IF)\nwlan.active(True)\nwlan.connect(ssid, password)\n\nprint('Connecting to WiFi...')\nstart = time.time()\nwhile not wlan.isconnected():\n    if time.time() - start > 20:\n        print('Failed to connect to WiFi after 20 seconds.')\n        raise RuntimeError('WiFi connection timeout')\n    time.sleep(1)\nif wlan.isconnected():\n    print('Connected:', wlan.ifconfig())\n    # Bandwidth test: download a chunk from a server\n    try:\n        import urequests\n    except ImportError:\n        import upip\n        upip.install('micropython-urequests')\n        import urequests\n    url = 'http://speedtest.ftp.otenet.gr/files/test10Mb.db'  # Example test file\n    start = time.ticks_ms()\n    try:\n        r = urequests.get(url)\n        data = r.content\n        r.close()\n        end = time.ticks_ms()\n        print('Downloaded', len(data), 'bytes in', (end-start)/1000, 'seconds')\n        print('Bandwidth:', len(data)/((end-start)/1000)/1024, 'KB/s')\n    except Exception as e:\n        print('Bandwidth test failed:', e)\nelse:\n    print('WiFi not connected.')\n`;
            // Send the script to the device via MicroPython REPL
            try {
                const writer = port.writable.getWriter();
                await writer.write(new TextEncoder().encode("\x03\r\n"));
                await new Promise(r => setTimeout(r, 100));
                await writer.write(new TextEncoder().encode(script + "\r\n"));
                writer.releaseLock();
                alert('WiFi test script sent and running! Check the terminal for output.');
            } catch (err) {
                alert('Failed to send script: ' + (err.message || err));
            }
        });

        // Add a modal for reconnecting after firmware update (place this outside any event handler)
        if (!document.getElementById('fw-reconnect-modal')) {
            const modal = document.createElement('div');
            modal.id = 'fw-reconnect-modal';
            modal.style.display = 'none';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100vw';
            modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '10002';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.innerHTML = `
              <div style="background:#222;padding:32px 24px;border-radius:16px;box-shadow:0 0 32px var(--mod-color,#0f0);display:flex;flex-direction:column;align-items:center;">
                <div style="color:var(--mod-color,#0f0);font-size:18px;margin-bottom:16px;">Device disconnected after firmware update.<br>Please reconnect using the button below.</div>
                <button id="fw-reconnect-btn" style="padding:12px 32px;border-radius:8px;background:var(--mod-color,#0f0);color:#111;font-weight:bold;border:none;cursor:pointer;font-size:16px;">Reconnect</button>
              </div>
            `;
            document.body.appendChild(modal);
        }
        const fwReconnectModal = document.getElementById('fw-reconnect-modal');
        const fwReconnectBtn = document.getElementById('fw-reconnect-btn');
        if (fwReconnectBtn) {
            fwReconnectBtn.onclick = async () => {
                fwReconnectModal.style.display = 'none';
                if (window.USBManager?.manualConnect) {
                    try {
                        await window.USBManager.manualConnect();
                    } catch (e) {
                        alert('Reconnect failed: ' + (e.message || e));
                    }
                }
            };
        }

        let mctReady = false;
        let bleMonitor = null;
        
        // Initialize BLE Monitor
        async function initBLEMonitor() {
            try {
                const { BLEMonitor } = await import('./js/ble-monitor.js');
                bleMonitor = new BLEMonitor();
                console.log('[MCC] BLE Monitor initialized');
            } catch (error) {
                console.error('[MCC] Failed to initialize BLE Monitor:', error);
            }
        }
        
        // BLE Monitor button handler
        document.addEventListener('DOMContentLoaded', () => {
            const bleMonitorBtn = document.getElementById('ble-monitor-btn');
            if (bleMonitorBtn) {
                bleMonitorBtn.addEventListener('click', () => {
                    if (bleMonitor) {
                        bleMonitor.show();
                    } else {
                        console.error('[MCC] BLE Monitor not initialized');
                        alert('BLE Monitor not available. Please refresh the page.');
                    }
                });
            }
        });
        
        // Initialize BLE Monitor when page loads
        initBLEMonitor();
        
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'mct-ready') {
                mctReady = true;
                console.log('[MCC] mct.html iframe is ready');
                // Send the current color immediately
                const color = localStorage.getItem('modColor') || '#00ff00';
                const portalIframe = document.querySelector('#canvas-container iframe');
                if (portalIframe && portalIframe.contentWindow) {
                    console.log('[MCC] Sending initial color to mct:', color);
                    portalIframe.contentWindow.postMessage({ type: 'set-mct-color', color }, '*');
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // ... existing code ...
            // Toggle logic for connect buttons
            const connectButtons = [
                { btn: document.getElementById('serial-connect-btn'), type: 'serial' },
                { btn: document.getElementById('wifi-connect-btn'), type: 'wifi' },
                { btn: document.getElementById('ble-connect-btn'), type: 'ble' }
            ];
            connectButtons.forEach(({btn, type}) => {
                if (btn) {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('active');
                        // Optionally, call your connect/disconnect logic here
                        // For example: toggleConnection(type);
                    });
                }
            });
            // ... existing code ...
        });
    </script>
</body>
</html>


