<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCT Installation & Testing</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://www.advancedvapesupply.com/cdn/shop/files/AVS_Molecule_5_180x180.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap">
    <script type="module" src="https://unpkg.com/esp-web-tools@9.4.3/dist/web/install-button.js?module"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --neon-green: #00ff00;
            --neon-green-glow: 0 0 10px rgba(0, 255, 0, 0.5);
            --neon-green-intense: 0 0 20px rgba(0, 255, 0, 0.8), 0 0 30px rgba(0, 255, 0, 0.6);
            --neon-blue: #0088ff;
            --neon-blue-glow: 0 0 10px rgba(0, 136, 255, 0.5);
            --neon-blue-intense: 0 0 20px rgba(0, 136, 255, 0.8), 0 0 30px rgba(0, 136, 255, 0.6);
            --neon-cyan: #00ffff;
            --neon-cyan-glow: 0 0 10px rgba(0, 255, 255, 0.5);
            --neon-cyan-intense: 0 0 20px rgba(0, 255, 255, 0.8), 0 0 30px rgba(0, 255, 255, 0.6);
            --neon-red: #e31837;
            --neon-red-glow: 0 0 10px rgba(227, 24, 55, 0.5);
            --neon-red-intense: 0 0 20px rgba(227, 24, 55, 0.8), 0 0 30px rgba(227, 24, 55, 0.6);
            --neon-yellow: #ffd43b;
            --neon-yellow-glow: 0 0 10px rgba(255, 212, 59, 0.5);
            --neon-yellow-intense: 0 0 20px rgba(255, 212, 59, 0.8), 0 0 30px rgba(255, 212, 59, 0.6);
            --tile-background: #1a1a1a;
            --border-color: rgba(0, 255, 0, 0.3);
        }

        body {
            margin: 0;
            overflow-x: hidden;
            background: #000000;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--neon-green);
        }

        /* iPhone Status Bar */
        #iphone-status-bar {
            width: 100%;
            height: 44px;
            background: rgba(0, 20, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: var(--neon-green);
            font-weight: 600;
            text-shadow: var(--neon-green-glow);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .battery-icon {
            width: 25px;
            height: 12px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 3px;
            position: relative;
            margin-left: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .battery-icon::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 3px;
            width: 2px;
            height: 4px;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 0 1px 1px 0;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .battery-icon.active {
            border-color: var(--neon-green);
            box-shadow: var(--neon-green-glow);
            opacity: 1;
        }

        .battery-icon.active::after {
            background: var(--neon-green);
            box-shadow: var(--neon-green-glow);
        }

        .battery-level {
            position: absolute;
            left: 1px;
            top: 1px;
            bottom: 1px;
            width: 80%;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .battery-icon.active .battery-level {
            background: var(--neon-green);
            box-shadow: var(--neon-green-intense);
        }

        /* App Container */
        #app-container {
            width: 100%;
            max-width: 430px;
            margin: 0 auto;
            min-height: calc(100vh - 44px);
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(145deg, rgba(0, 40, 0, 0.9) 0%, rgba(0, 20, 0, 0.9) 100%);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: var(--neon-green-glow);
            color: var(--neon-green);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
            color: var(--neon-green);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Tile Styling */
        .tile {
            background-color: var(--tile-background);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }

        .tile h2 {
            color: var(--neon-green);
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-shadow: var(--neon-green-glow);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
            padding-bottom: 10px;
        }

        /* Step Styling */
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 40, 0, 0.3);
            border-left: 3px solid var(--neon-green);
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.1);
        }

        .step h3 {
            color: var(--neon-green);
            margin-bottom: 8px;
            font-size: 1rem;
            text-shadow: var(--neon-green-glow);
        }

        .step p {
            color: rgba(0, 255, 0, 0.8);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .step-number {
            display: inline-block;
            background: var(--neon-green);
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            margin-right: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: var(--neon-green-glow);
        }

        /* Device State Indicator */
        .device-state-indicator {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 20, 0, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-state-label {
            color: var(--neon-green);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .device-state-status {
            color: rgba(0, 255, 0, 0.8);
            font-family: 'Fira Code', monospace;
            font-size: 0.85rem;
            flex: 1;
        }

        .device-state-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s ease;
            position: relative;
        }

        .device-state-dot.unknown {
            background: #666;
        }

        .device-state-dot.normal {
            background: var(--neon-blue);
            box-shadow: var(--neon-blue-glow);
        }

        .device-state-dot.bootloader {
            background: var(--neon-yellow);
            box-shadow: var(--neon-yellow-glow);
            animation: pulse 2s infinite;
        }

        .device-state-dot.connected {
            background: var(--neon-green);
            box-shadow: var(--neon-green-glow);
        }

        .device-state-dot.error {
            background: var(--neon-red);
            box-shadow: var(--neon-red-glow);
        }

        /* Install Button */
        .install-section {
            text-align: center;
            margin: 20px 0;
        }

        esp-web-install-button {
            --esp-tools-button-color: var(--neon-green);
            --esp-tools-button-text-color: #000;
            --esp-tools-button-selected-color: var(--neon-green);
        }

        .install-button {
            background: linear-gradient(145deg, rgba(0, 40, 0, 0.9) 0%, rgba(0, 20, 0, 0.9) 100%);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-shadow: var(--neon-green-glow);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .install-button:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: var(--neon-green-intense);
        }

        /* Connection Info */
        .connection-info {
            background: rgba(0, 40, 0, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .connection-info h4 {
            color: var(--neon-green);
            margin-bottom: 10px;
            text-shadow: var(--neon-green-glow);
        }

        .connection-info p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: rgba(0, 255, 0, 0.8);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            background: #333;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: var(--neon-green);
            box-shadow: var(--neon-green-glow);
        }

        .status-indicator.disconnected {
            background: #333;
        }

        .status-indicator.connecting {
            background: var(--neon-yellow);
            box-shadow: var(--neon-yellow-glow);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Test Controls */
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .test-button {
            background: linear-gradient(145deg, rgba(0, 40, 0, 0.9) 0%, rgba(0, 20, 0, 0.9) 100%);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            text-shadow: var(--neon-green-glow);
        }

        .test-button:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: var(--neon-green-glow);
        }

        .test-button.secondary {
            border-color: rgba(0, 255, 0, 0.5);
            color: rgba(0, 255, 0, 0.7);
        }

        .test-button.secondary:hover {
            background: rgba(0, 255, 0, 0.1);
            color: var(--neon-green);
        }

        /* Test Status Bar */
        .test-status-bar {
            margin-bottom: 20px;
            padding: 12px;
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            text-align: center;
        }

        .status {
            font-weight: bold;
            color: var(--neon-green);
        }

        .status.running {
            color: var(--neon-blue);
        }

        .status.error {
            color: var(--neon-red);
        }

        .status.completed {
            color: var(--neon-green);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 40, 0, 0.6);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid rgba(0, 255, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-cyan));
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        /* Test Results */
        .test-results {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .test-result, .test-tile {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .test-result:hover, .test-tile:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 255, 0, 0.2);
        }

        .test-result.pass, .test-tile.pass {
            background: rgba(0, 255, 0, 0.1);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .test-result.fail, .test-tile.fail {
            background: rgba(227, 24, 55, 0.1);
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .test-result.skip, .test-tile.skip {
            background: rgba(255, 212, 59, 0.1);
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }

        .test-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .test-status {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 4px;
        }

        .test-details {
            font-size: 0.75rem;
            opacity: 0.7;
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .test-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-result-expand-icon {
            font-size: 0.8rem;
            opacity: 0.7;
            transition: transform 0.3s ease;
        }

        .test-result.expanded .test-result-expand-icon {
            transform: rotate(180deg);
        }

        .test-result-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .test-result.expanded .test-result-details {
            max-height: 200px;
            margin-top: 10px;
        }

        .test-result-expanded-content {
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            font-size: 0.75rem;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Test Summary */
        .test-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-card {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid;
            background: rgba(0, 20, 0, 0.6);
        }

        .summary-card.pass {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .summary-card.fail {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        .summary-card.skip {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }

        .summary-card.total {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .summary-card h3 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
        }

        .summary-card p {
            font-size: 1.5rem;
            margin: 5px 0;
            font-weight: bold;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-top: 2px solid var(--neon-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Safari Bottom Bar */
        #safari-bar {
            width: 100%;
            height: 45px;
            background: rgba(0, 20, 0, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            border-top: 1px solid rgba(0, 255, 0, 0.2);
        }

        .url-bar {
            flex: 1;
            height: 32px;
            margin: 0 10px;
            background: rgba(0, 40, 0, 0.6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 14px;
            color: var(--neon-green);
            border: 1px solid rgba(0, 255, 0, 0.3);
            text-shadow: var(--neon-green-glow);
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
            color: var(--neon-green);
            text-shadow: var(--neon-green-glow);
            font-size: 18px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .test-controls {
                flex-direction: column;
            }
            
            .test-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- iPhone Status Bar -->
    <div id="iphone-status-bar">
        <div class="status-left">
            <span>9:41</span>
        </div>
        <div class="status-right">
            <span>100%</span>
            <div class="battery-icon active">
                <div class="battery-level"></div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-microchip"></i> MCT Installation & Testing</h1>
            <p>Install firmware and run comprehensive system tests</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Installation Section -->
            <div class="tile">
                <h2><i class="fas fa-download"></i> Firmware Installation</h2>
                
                <div class="step">
                    <h3><span class="step-number">1</span>Enter Bootloader Mode</h3>
                    <p>To enter bootloader mode:</p>
                    <ol style="margin: 8px 0 0 20px; color: rgba(0, 255, 0, 0.8);">
                        <li>Press and hold the <strong>SELECT</strong> button on your MCT device</li>
                        <li>While holding SELECT, cycle power by:
                            <ul style="margin: 4px 0 0 20px;">
                                <li>Removing the battery (if installed)</li>
                                <li>Unplugging the USB cable</li>
                                <li>Reconnecting the USB cable</li>
                            </ul>
                        </li>
                        <li>Release the SELECT button after reconnecting USB</li>
                    </ol>
                    <div class="device-state-indicator">
                        <span class="device-state-label">Device State:</span>
                        <span class="device-state-status" id="device-state">Unknown</span>
                        <div class="device-state-dot" id="device-state-dot"></div>
                    </div>
                </div>

                <div class="step">
                    <h3><span class="step-number">2</span>Connect USB Cable</h3>
                    <p>Connect your MCT device to your computer via USB cable. The device should now be in bootloader mode and ready for firmware installation.</p>
                </div>

                <div class="step">
                    <h3><span class="step-number">3</span>Install Firmware</h3>
                    <p>Click the install button below to flash the latest MCT firmware to your device. The installer will automatically detect the device and begin flashing.</p>
                </div>

                <div class="install-section">
                    <esp-web-install-button 
                        manifest="manifest.json"
                        class="install-button">
                        <i class="fas fa-bolt"></i> Install MCT Firmware
                    </esp-web-install-button>
                </div>

                <div class="connection-info">
                    <h4><i class="fas fa-wifi"></i> Connection Status</h4>
                    <p><span class="status-indicator disconnected"></span>Device: <span id="device-status">Not Connected</span></p>
                    <p><span class="status-indicator disconnected"></span>WiFi: <span id="wifi-status">Not Connected</span></p>
                    <p><span class="status-indicator disconnected"></span>WebREPL: <span id="webrepl-status">Not Connected</span></p>
                </div>
            </div>

            <!-- Testing Section -->
            <div class="tile">
                <h2><i class="fas fa-flask"></i> System Testing</h2>
                
                <div class="step">
                    <h3><span class="step-number">4</span>Run Tests</h3>
                    <p>After installation, run comprehensive system tests to verify all components are working correctly.</p>
                </div>

                <div class="test-controls">
                    <button class="test-button" id="connect-btn">
                        <i class="fas fa-usb"></i> Connect Device
                    </button>
                    <button class="test-button" id="run-test-btn" disabled>
                        <span id="basic-test-icon"><i class="fas fa-play"></i></span> Run MCT Test
                    </button>
                    <button class="test-button secondary" onclick="clearResults()">
                        <i class="fas fa-trash"></i> Clear Results
                    </button>
                    <button class="test-button secondary" onclick="exportResults()">
                        <i class="fas fa-file-export"></i> Export Results
                    </button>
                </div>
                
                <div class="test-status-bar">
                    <div id="test-status" class="status ready">Ready to connect</div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="test-progress"></div>
                </div>

                <div class="test-results" id="test-results">
                    <div style="text-align: center; color: rgba(0, 255, 0, 0.6); padding: 20px;">
                        <i class="fas fa-info-circle"></i> Click a test button to start testing...
                    </div>
                </div>
            </div>

            <!-- Test Results Summary -->
            <div class="tile">
                <h2><i class="fas fa-chart-bar"></i> Test Summary</h2>
                <div id="test-summary">
                    <p style="color: rgba(0, 255, 0, 0.6);">No tests have been run yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Safari Bottom Bar -->
    <div id="safari-bar">
        <div class="nav-buttons">
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-right"></i>
        </div>
        <div class="url-bar">
            <i class="fas fa-lock" style="margin-right: 8px;"></i>
            mct-install.html
        </div>
        <div class="nav-buttons">
            <i class="fas fa-share"></i>
            <i class="fas fa-bookmark"></i>
        </div>
    </div>

    <script>
        let simulatedTestResults = [];
        let currentTest = null;
        let testProgress = 0;

        // Mock test data structure
        const testDefinitions = {
            basic: [
                { name: 'MicroPython Import', id: 'upy', description: 'Test MicroPython import functionality' },
                { name: 'REPL Responsive', id: 'repl', description: 'Test REPL responsiveness' },
                { name: 'WiFi Connection', id: 'wifi', description: 'Test WiFi connectivity' },
                { name: 'MCT Class', id: 'mct', description: 'Test MCT class initialization' },
                { name: 'BME280 Sensor', id: 'bme280', description: 'Test temperature/humidity sensor' },
                { name: 'ADC Reading', id: 'adc', description: 'Test analog-to-digital conversion' },
                { name: 'Power Measurement', id: 'power', description: 'Test power monitoring' },
                { name: 'Motion Sensor', id: 'motion', description: 'Test motion detection' }
            ],
            comprehensive: [
                { name: 'LED Control', id: 'led', description: 'Test LED functionality' },
                { name: 'Battery Status', id: 'battery', description: 'Test battery monitoring' },
                { name: 'Button Inputs', id: 'buttons', description: 'Test button inputs' },
                { name: 'R Sensor', id: 'r', description: 'Test R sensor functionality' },
                { name: 'Fire Detection', id: 'fire', description: 'Test fire detection system' },
                { name: 'Motor Control', id: 'motors', description: 'Test motor drivers' },
                { name: 'IMU Sensor', id: 'imu', description: 'Test inertial measurement unit' },
                { name: 'Pressure Sensor', id: 'pressure', description: 'Test pressure sensor' },
                { name: 'Humidity Sensor', id: 'humidity', description: 'Test humidity sensor' },
                { name: 'Temperature Sensor', id: 'temperature', description: 'Test temperature sensor' },
                { name: 'OTA Update', id: 'ota', description: 'Test over-the-air update capability' }
            ]
        };

        // Device state management
        let deviceState = 'unknown';
        const deviceStates = {
            'unknown': { text: 'Unknown', class: 'unknown' },
            'normal': { text: 'Normal Mode', class: 'normal' },
            'bootloader': { text: 'Bootloader Mode', class: 'bootloader' },
            'connected': { text: 'Connected & Ready', class: 'connected' },
            'error': { text: 'Connection Error', class: 'error' }
        };

        function updateDeviceState(newState) {
            deviceState = newState;
            const stateInfo = deviceStates[newState];
            
            const statusElement = document.getElementById('device-state');
            const dotElement = document.getElementById('device-state-dot');
            
            if (statusElement && dotElement) {
                statusElement.textContent = stateInfo.text;
                dotElement.className = `device-state-dot ${stateInfo.class}`;
            }
        }

        // Simulate device state detection
        function simulateDeviceStateDetection() {
            const states = ['unknown', 'normal', 'bootloader', 'connected', 'error'];
            const weights = [0.1, 0.2, 0.3, 0.3, 0.1]; // Probability weights
            
            let random = Math.random();
            let cumulativeWeight = 0;
            
            for (let i = 0; i < states.length; i++) {
                cumulativeWeight += weights[i];
                if (random <= cumulativeWeight) {
                    updateDeviceState(states[i]);
                    break;
                }
            }
        }

        // Simulate connection status updates
        function updateConnectionStatus() {
            const statuses = ['Not Connected', 'Connecting...', 'Connected'];
            const indicators = document.querySelectorAll('.status-indicator');
            const statusTexts = document.querySelectorAll('#device-status, #wifi-status, #webrepl-status');
            
            indicators.forEach((indicator, index) => {
                const random = Math.random();
                if (random > 0.7) {
                    indicator.className = 'status-indicator connected';
                    statusTexts[index].textContent = 'Connected';
                } else if (random > 0.4) {
                    indicator.className = 'status-indicator connecting';
                    statusTexts[index].textContent = 'Connecting...';
                } else {
                    indicator.className = 'status-indicator disconnected';
                    statusTexts[index].textContent = 'Not Connected';
                }
            });
        }

        // Update device state every 4 seconds
        setInterval(simulateDeviceStateDetection, 4000);
        
        // Update connection status every 3 seconds
        setInterval(updateConnectionStatus, 3000);

        // Real device connection and testing system
        let devicePort = null;
        let deviceConnected = false;
        let testRunning = false;
        let realTestResults = {};

        // USB Serial connection management
        class USBManager {
            constructor() {
                this.currentPort = null;
                this.reader = null;
                this.writer = null;
                this.isReading = false;
            }

            async connect() {
                try {
                    // Request USB device
                    this.currentPort = await navigator.serial.requestPort();
                    await this.currentPort.open({ baudRate: 115200 });
                    
                    this.writer = this.currentPort.writable.getWriter();
                    this.reader = this.currentPort.readable.getReader();
                    
                    return true;
                } catch (error) {
                    console.error('USB connection failed:', error);
                    return false;
                }
            }

            async disconnect() {
                if (this.reader) {
                    await this.reader.cancel();
                    this.reader.releaseLock();
                    this.reader = null;
                }
                if (this.writer) {
                    this.writer.releaseLock();
                    this.writer = null;
                }
                if (this.currentPort) {
                    await this.currentPort.close();
                    this.currentPort = null;
                }
            }

            async sendCommand(command) {
                if (!this.writer) throw new Error('Device not connected');
                
                const encoder = new TextEncoder();
                await this.writer.write(encoder.encode(command + '\r\n'));
            }

            async readResponse(timeout = 5000) {
                if (!this.reader) throw new Error('Device not connected');
                
                const decoder = new TextDecoder();
                let response = '';
                const startTime = Date.now();
                
                while (Date.now() - startTime < timeout) {
                    try {
                        const { value, done } = await this.reader.read();
                        if (done) break;
                        
                        response += decoder.decode(value);
                        
                        // Check if we have a complete response
                        if (response.includes('>>>') || response.includes('...')) {
                            break;
                        }
                    } catch (error) {
                        console.error('Read error:', error);
                        break;
                    }
                }
                
                return response;
            }
        }

        const usbManager = new USBManager();

        // Device connection functions
        async function connectToDevice() {
            updateDeviceState('connecting');
            
            try {
                const connected = await usbManager.connect();
                if (connected) {
                    devicePort = usbManager.currentPort;
                    deviceConnected = true;
                    updateDeviceState('connected');
                    
                    // Test basic communication
                    await usbManager.sendCommand('\x03'); // Ctrl-C to interrupt
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await usbManager.sendCommand('print("MCT_INSTALL_READY")');
                    
                    const response = await usbManager.readResponse(2000);
                    if (response.includes('MCT_INSTALL_READY')) {
                        updateDeviceState('ready');
                        return true;
                    }
                }
                throw new Error('Failed to establish communication');
            } catch (error) {
                console.error('Connection failed:', error);
                updateDeviceState('error');
                deviceConnected = false;
                return false;
            }
        }

        async function disconnectFromDevice() {
            try {
                await usbManager.disconnect();
                deviceConnected = false;
                devicePort = null;
                updateDeviceState('unknown');
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }

        // Real MCT_TEST execution
        async function runMCTTest() {
            if (!deviceConnected) {
                alert('Please connect to device first!');
                return;
            }

            if (testRunning) {
                alert('Test already running!');
                return;
            }

            testRunning = true;
            realTestResults = {};
            
            // Update UI to show test is running
            updateTestStatus('running');
            clearTestResults();
            
            try {
                // Send interrupt to clear any running code
                await usbManager.sendCommand('\x03');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Import and run MCT_TEST
                const testScript = `
import json
import time
from lib.io.MCT_TEST import MCT_TEST
from lib.io.MCT import MCT

print("=== MCT Test Suite Starting ===")
print("Creating MCT instance...")

try:
    mct = MCT()
    print("MCT instance created successfully")
    
    print("Creating MCT_TEST instance...")
    tester = MCT_TEST(mct)
    print("MCT_TEST instance created successfully")
    
    print("Running comprehensive test...")
    tester.comprehensive_test("auto")
    
    print("Test completed, getting results...")
    results = tester.results
    
    print("MCT_TEST_RESULTS_START")
    print(json.dumps(results))
    print("MCT_TEST_RESULTS_END")
    
except Exception as e:
    print("MCT_TEST_ERROR:", str(e))
    import sys
    sys.print_exception(e)
    
print("=== MCT Test Suite Finished ===")
`;

                // Send the test script
                await usbManager.sendCommand(testScript);
                
                // Read response with longer timeout for comprehensive test
                const response = await usbManager.readResponse(30000); // 30 second timeout
                
                // Parse test results from response
                const resultsMatch = response.match(/MCT_TEST_RESULTS_START\s*\n(.*?)\nMCT_TEST_RESULTS_END/s);
                if (resultsMatch) {
                    try {
                        const results = JSON.parse(resultsMatch[1]);
                        realTestResults = results;
                        displayTestResults(results);
                        updateTestStatus('completed');
                    } catch (parseError) {
                        console.error('Failed to parse test results:', parseError);
                        updateTestStatus('error');
                        displayTestError('Failed to parse test results');
                    }
                } else if (response.includes('MCT_TEST_ERROR:')) {
                    const errorMatch = response.match(/MCT_TEST_ERROR:\s*(.+)/);
                    const errorMsg = errorMatch ? errorMatch[1] : 'Unknown error';
                    updateTestStatus('error');
                    displayTestError(errorMsg);
                } else {
                    updateTestStatus('error');
                    displayTestError('No test results received');
                }
                
            } catch (error) {
                console.error('Test execution failed:', error);
                updateTestStatus('error');
                displayTestError(error.message);
            } finally {
                testRunning = false;
            }
        }

        // Display real test results
        function displayTestResults(results) {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            if (!results || !results.results) {
                displayTestError('Invalid test results format');
                return;
            }
            
            const testData = results.results;
            let totalTests = 0;
            let passedTests = 0;
            
            // Create test result tiles
            Object.entries(testData).forEach(([testName, testResult]) => {
                totalTests++;
                const passed = testResult.status === 'PASS';
                if (passed) passedTests++;
                
                const tile = document.createElement('div');
                tile.className = `test-tile ${passed ? 'pass' : testResult.status === 'SKIP' ? 'skip' : 'fail'}`;
                tile.innerHTML = `
                    <div class="test-name">${testName.toUpperCase()}</div>
                    <div class="test-status">${testResult.status}</div>
                    <div class="test-details">${testResult.details || 'No details'}</div>
                `;
                
                // Add click handler for expandable details
                tile.addEventListener('click', () => {
                    const details = tile.querySelector('.test-details');
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                });
                
                container.appendChild(tile);
            });
            
            // Update summary
            const summary = document.getElementById('test-summary');
            summary.innerHTML = `
                <div class="summary-item">
                    <i class="fas fa-check-circle"></i>
                    <span>Passed: ${passedTests}</span>
                </div>
                <div class="summary-item">
                    <i class="fas fa-times-circle"></i>
                    <span>Failed: ${totalTests - passedTests}</span>
                </div>
                <div class="summary-item">
                    <i class="fas fa-list"></i>
                    <span>Total: ${totalTests}</span>
                </div>
            `;
        }

        function displayTestError(errorMsg) {
            const container = document.getElementById('test-results');
            container.innerHTML = `
                <div class="test-tile fail">
                    <div class="test-name">TEST ERROR</div>
                    <div class="test-status">FAIL</div>
                    <div class="test-details">${errorMsg}</div>
                </div>
            `;
            
            const summary = document.getElementById('test-summary');
            summary.innerHTML = `
                <div class="summary-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Test execution failed</span>
                </div>
            `;
        }

        function clearTestResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="loading">Running tests...</div>';
            
            const summary = document.getElementById('test-summary');
            summary.innerHTML = '<div class="loading">Please wait...</div>';
        }

        function updateTestStatus(status) {
            const statusEl = document.getElementById('test-status');
            const runBtn = document.getElementById('run-test-btn');
            
            switch (status) {
                case 'running':
                    statusEl.textContent = 'Running tests...';
                    statusEl.className = 'status running';
                    runBtn.disabled = true;
                    runBtn.textContent = 'Running...';
                    break;
                case 'completed':
                    statusEl.textContent = 'Tests completed';
                    statusEl.className = 'status completed';
                    runBtn.disabled = false;
                    runBtn.textContent = 'Run Test Again';
                    break;
                case 'error':
                    statusEl.textContent = 'Test failed';
                    statusEl.className = 'status error';
                    runBtn.disabled = false;
                    runBtn.textContent = 'Retry Test';
                    break;
                default:
                    statusEl.textContent = 'Ready to test';
                    statusEl.className = 'status ready';
                    runBtn.disabled = false;
                    runBtn.textContent = 'Run MCT Test';
            }
        }

        // Add missing utility functions
        function clearResults() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div style="text-align: center; color: rgba(0, 255, 0, 0.6); padding: 20px;"><i class="fas fa-info-circle"></i> Click a test button to start testing...</div>';
            
            const summary = document.getElementById('test-summary');
            summary.innerHTML = '<p style="color: rgba(0, 255, 0, 0.6);">No tests have been run yet.</p>';
        }

        function exportResults() {
            if (!realTestResults || Object.keys(realTestResults).length === 0) {
                alert('No test results to export');
                return;
            }
            
            const dataStr = JSON.stringify(realTestResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `mct-test-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Enhanced device connection with better error handling
        async function connectToDevice() {
            const connectBtn = document.getElementById('connect-btn');
            const runBtn = document.getElementById('run-test-btn');
            
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            updateDeviceState('connecting');
            
            try {
                const connected = await usbManager.connect();
                if (connected) {
                    devicePort = usbManager.currentPort;
                    deviceConnected = true;
                    
                    // Test basic communication
                    await usbManager.sendCommand('\x03'); // Ctrl-C to interrupt
                    await new Promise(resolve => setTimeout(resolve, 100));
                    await usbManager.sendCommand('print("MCT_INSTALL_READY")');
                    
                    const response = await usbManager.readResponse(2000);
                    if (response.includes('MCT_INSTALL_READY')) {
                        updateDeviceState('connected');
                        connectBtn.innerHTML = '<i class="fas fa-check"></i> Connected';
                        connectBtn.disabled = false;
                        runBtn.disabled = false;
                        updateTestStatus('ready');
                        return true;
                    }
                }
                throw new Error('Failed to establish communication');
            } catch (error) {
                console.error('Connection failed:', error);
                updateDeviceState('error');
                deviceConnected = false;
                connectBtn.innerHTML = '<i class="fas fa-usb"></i> Connect Device';
                connectBtn.disabled = false;
                runBtn.disabled = true;
                alert('Connection failed: ' + error.message);
                return false;
            }
        }

        // Event listeners
        document.getElementById('connect-btn').addEventListener('click', connectToDevice);
        document.getElementById('run-test-btn').addEventListener('click', runMCTTest);

        // Listen for installation events
        document.addEventListener('DOMContentLoaded', function() {
            const installButton = document.querySelector('esp-web-install-button');
            
            if (installButton) {
                installButton.addEventListener('esp-web-install-button-install-start', function() {
                    console.log('Installation started');
                    document.getElementById('device-status').textContent = 'Installing...';
                    updateDeviceState('connected');
                });
                
                installButton.addEventListener('esp-web-install-button-install-success', function() {
                    console.log('Installation successful');
                    document.getElementById('device-status').textContent = 'Installed Successfully';
                    updateDeviceState('connected');
                    // Auto-connect after successful installation
                    setTimeout(connectToDevice, 2000);
                });
                
                installButton.addEventListener('esp-web-install-button-install-error', function(event) {
                    console.log('Installation failed:', event.detail);
                    document.getElementById('device-status').textContent = 'Installation Failed';
                    updateDeviceState('error');
                });
            }
        });

        // Initialize battery animation and device state
        document.addEventListener('DOMContentLoaded', function() {
            const batteryIcon = document.querySelector('.battery-icon');
            if (batteryIcon) {
                batteryIcon.classList.add('active');
            }
            
            // Initialize device state
            updateDeviceState('unknown');
        });
    </script>
</body>
</html> 